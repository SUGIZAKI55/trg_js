<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
            max-width: 800px; /* ã‚³ãƒ³ãƒ†ãƒŠã®æœ€å¤§å¹…ã‚’è¨­å®š */
        }
        .error-message {
            color: red;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .success-message {
            color: green;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .signup-link, .login-link {
            text-align: center;
            margin-top: 15px;
        }
        .signup-link a, .login-link a {
            color: #4CAF50;
        }

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab {
            text-align: center;
            margin-top: 50px;
        }
        .tab button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .tab button:hover {
            background-color: #e0e0e0;
        }
        /* Bootstrapã®ãƒœã‚¿ãƒ³ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«èª¿æ•´ */
        .btn-block {
            width: 100%;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        table {
            width: 90%; /* å°‘ã—åºƒã‚ã« */
            border-collapse: collapse;
            margin: 20px auto; /* ä¸­å¤®å¯„ã› */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* å½±ã‚’è¿½åŠ  */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
            text-align: center;
            vertical-align: middle; /* å‚ç›´æ–¹å‘ä¸­å¤®å¯„ã› */
        }
        th {
            background-color: #e9ecef; /* å°‘ã—æ¿ƒã„èƒŒæ™¯è‰² */
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2; /* å¶æ•°è¡Œã®èƒŒæ™¯è‰² */
        }
        tr:hover {
            background-color: #e6e6e6; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
        }

        /* ã‚°ãƒ©ãƒ•ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chart-container {
            width: 90%; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¨åŒã˜å¹…ã«åˆã‚ã›ã‚‹ãªã© */
            margin: 40px auto; /* ä¸­å¤®å¯„ã›ã¨ä¸Šä¸‹ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
            background-color: #ffffff;
            padding: 25px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
            border-radius: 10px; /* è§’ã‚’ä¸¸ã */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* å½±ã‚’å¼·èª¿ */
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½™ç™½ */
        .form-group {
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script>
        console.log('--- Script Start ---');

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function render(componentHtml) {
            document.getElementById('root').innerHTML = componentHtml;
        }

        function navigate(path, state = {}) {
            console.log('NAVIGATE: Function called with path:', path, 'state:', state);
            // ç¾åœ¨ã®URLãŒåŒã˜ã§ã‚ã‚Œã°pushStateã—ãªã„ï¼ˆå±¥æ­´ãŒé‡è¤‡ã™ã‚‹ã®ã‚’é˜²ãï¼‰
            if (window.location.pathname !== path || JSON.stringify(history.state) !== JSON.stringify(state)) {
                history.pushState(state, '', path);
                console.log('NAVIGATE: After pushState, current URL:', window.location.pathname);
                handleRouting(); // URLãŒå¤‰ã‚ã£ãŸã®ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å†å®Ÿè¡Œ
            } else {
                console.log('NAVIGATE: Path and state are identical, skipping pushState and re-routing.');
                // åŒã˜URLã§ã‚‚ã€æ˜ç¤ºçš„ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã¯handleRouting()ã‚’å‘¼ã¶
                // handleRouting();
            }
        }

        // --- èªè¨¼çŠ¶æ…‹ç®¡ç† ---
        const Auth = {
            token: localStorage.getItem('token') || null,
            username: localStorage.getItem('username') || null,
            role: localStorage.getItem('role') || null, // â˜…è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’ç®¡ç†

            setToken(newToken) {
                this.token = newToken;
                if (newToken) localStorage.setItem('token', newToken);
                else localStorage.removeItem('token');
            },
            setUsername(newUsername) {
                this.username = newUsername;
                if (newUsername) localStorage.setItem('username', newUsername);
                else localStorage.removeItem('username');
            },
            setRole(newRole) { // â˜…è¿½åŠ : ãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                this.role = newRole;
                if (newRole) localStorage.setItem('role', newRole);
                else localStorage.removeItem('role');
            },
            // â˜…å¤‰æ›´: newRole ã‚’å¼•æ•°ã«è¿½åŠ 
            login(newToken, newUsername, newRole) {
                console.log('AUTH: Login successful, setting token, username, and role.');
                this.setToken(newToken);
                this.setUsername(newUsername);
                this.setRole(newRole); // â˜…è¿½åŠ 
                // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç®¡ç†è€…ãªã‚‰/adminã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰/genreã¸é·ç§»
                if (newRole === 'admin') {
                    navigate('/admin');
                } else {
                    navigate('/genre'); 
                }
                console.log('AUTH: navigate(/admin or /genre) called.');
            },
            logout() {
                console.log('AUTH: Logging out, clearing token, username, and role.');
                this.setToken(null);
                this.setUsername(null);
                this.setRole(null); // â˜…è¿½åŠ 
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã«Loginãƒšãƒ¼ã‚¸ã¸é·ç§»
                navigate('/login');
            },
            isAuthenticated() { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
                return this.token !== null && this.username !== null;
            },
            isAdmin() { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
                return this.isAuthenticated() && this.role === 'admin';
            }
        };

        // --- å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

        // Login ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderLogin(initialError = '') {
            console.log('RENDERLOGIN: Function called, rendering Login page.');
            let errorMessage = initialError; // åˆæœŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹ãŸã‚ã®å¼•æ•°
            let successMessage = ''; // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®å¤‰æ•°

            // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (history.state && history.state.signupSuccess) {
                successMessage = 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã€çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
                history.replaceState({}, '', '/login'); // URLã¯ãã®ã¾ã¾ã€çŠ¶æ…‹ã ã‘ã‚¯ãƒªã‚¢
            }

            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                errorMessage = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        // â˜…å¤‰æ›´: data.role ã‚’ Auth.login ã«æ¸¡ã™
                        Auth.login(data.token, data.username, data.role); 
                    } else {
                        errorMessage = data.message || 'Login failed';
                        renderLogin(errorMessage); // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    }
                } catch (err) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message; 
                    console.error('Login network error:', err);
                    renderLogin(errorMessage); // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤º
                }
            };

            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    ${successMessage ? `<div class="success-message">${successMessage}</div>` : ''}
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </form>
                    <div class="signup-link">
                        <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ <a href="/signup">æ–°è¦ç™»éŒ²</a></p>
                    </div>
                </div>
            `;
            render(html);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
            document.getElementById('loginForm').addEventListener('submit', handleSubmit);
            document.querySelector('.signup-link a').addEventListener('click', (e) => {
                e.preventDefault();
                navigate('/signup');
            });
        }

        // Signup ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderSignup(initialError = '') {
            console.log('RENDERSIGNUP: Function called, rendering Signup page.');
            let errorMessage = initialError;

            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                const confirmPassword = event.target.confirmPassword.value;
                errorMessage = '';

                if (password !== confirmPassword) {
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚';
                    renderSignup(errorMessage); 
                    return;
                }
                if (password.length < 6) { // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ€ä½æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    renderSignup(errorMessage);
                    return;
                }

                try {
                    const response = await fetch('/api/auth/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸæ™‚ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®çŠ¶æ…‹ã‚’æ¸¡ã™
                        navigate('/login', { signupSuccess: true });
                    } else {
                        errorMessage = data.message || 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    }
                } catch (err) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message;
                    console.error('Signup network error:', err);
                }
                renderSignup(errorMessage); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ãŸã‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            };

            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">æ–°è¦ç™»éŒ²</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    <form id="signupForm">
                        <div class="form-group">
                            <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                            <small class="form-text text-muted">6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰:</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">æ–°è¦ç™»éŒ²</button>
                    </form>
                    <div class="login-link">
                        <p>ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ <a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
                    </div>
                </div>
            `;
            render(html);

            document.getElementById('signupForm').addEventListener('submit', handleSubmit);
            document.querySelector('.login-link a').addEventListener('click', (e) => {
                e.preventDefault();
                navigate('/login');
            });
        }

        // Admin ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderAdmin() {
            console.log('RENDERADMIN: Function called, rendering Admin page.');
            // â˜…å¤‰æ›´: Auth.isAdmin() ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
            if (!Auth.isAdmin()) {
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre'); 
                return;
            }

            const handleLogout = () => {
                Auth.logout();
            };

            const html = `
                <div class="container">
                    <h1 class="text-center">${Auth.username || 'ã‚²ã‚¹ãƒˆ'} ã®ç®¡ç†è€…ç”»é¢</h1>
                    <div class="tab">
                        <button id="testButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½</button>
                        <button id="qListButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆä¸€è¦§ãƒ»ç·¨é›†</button>
                        <button id="createQuizButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆä½œæˆ</button>
                        <button id="viewResultsButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆçµæœ</button>
                        <button id="logoutButton" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>
            `;
            render(html);

            document.getElementById('testButton').addEventListener('click', () => navigate('/genre'));
            document.getElementById('qListButton').addEventListener('click', () => navigate('/q_list'));
            document.getElementById('createQuizButton').addEventListener('click', () => navigate('/createquiz'));
            document.getElementById('viewResultsButton').addEventListener('click', () => navigate('/view'));
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        }

        // QuestionList ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        async function renderQuestionList() {
            console.log('RENDERQUESTIONLIST: Function called.');
            // â˜…å¤‰æ›´: Auth.isAdmin() ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
            if (!Auth.isAdmin()) {
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre');
                return;
            }
            let questions = [];
            let error = '';

            try {
                const token = Auth.token;
                if (!token) { // ã“ã“ã¯isAdmin()ã§æ—¢ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã¯ãšã ãŒå¿µã®ãŸã‚
                    error = 'èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                    navigate('/login');
                    return;
                }
                const response = await fetch('/api/quiz/questions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    questions = await response.json();
                } else if (response.status === 401 || response.status === 403) {
                    error = 'èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
                    Auth.logout();
                } else {
                    const data = await response.json();
                    error = data.message || 'å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                }
            } catch (err) {
                error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
                console.error('Error fetching questions:', err);
            }

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œä¸€è¦§</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <ul class="list-group">
                        ${questions.length > 0 ? questions.map(question => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    ${question.Q_no !== null ? question.Q_no + ' | ' : ''}${question.genre} | ${question.title.length > 50 ? question.title.substring(0, 50) + '...' : question.title}
                                </span>
                                <button data-id="${question.rowid}" class="edit-button btn btn-sm btn-info ml-2">ç·¨é›†</button>
                            </li>
                        `).join('') : '<li class="list-group-item text-center">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>'}
                    </ul>
                    <a href="/createquiz" id="createQuizLink" class="btn btn-primary mt-4 btn-block">å•é¡Œä½œæˆ</a>
                </div>
            `;
            render(html);

            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionId = e.target.dataset.id;
                    navigate(`/edit/${questionId}`);
                });
            });
            document.getElementById('createQuizLink').addEventListener('click', (e) => {
                e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯é·ç§»ã‚’é˜²ã
                navigate('/createquiz');
            });
        }

        // EditQuestion ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        async function renderEditQuestion(questionId) {
            console.log('RENDEREDITQUESTION: Function called with ID:', questionId);
            if (!Auth.isAdmin()) {
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre');
                return;
            }
            let question = { Q_no: '', genre: '', title: '', choices: '', answer: '', explanation: '' };
            let error = '';
            const token = Auth.token;

            try {
                const response = await fetch(`/api/quiz/questions/${questionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    question = data;
                } else if (response.status === 401 || response.status === 403) {
                    error = 'èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
                    Auth.logout();
                } else {
                    error = data.message || 'å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                }
            } catch (err) {
                error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
                console.error('Error fetching question:', err);
            }

            const handleSubmit = async (event) => {
                event.preventDefault();
                const updatedQuestion = {
                    Q_no: event.target.Q_no.value,
                    genre: event.target.genre.value,
                    title: event.target.title.value,
                    choices: event.target.choices.value,
                    answer: event.target.answer.value,
                    explanation: event.target.explanation.value,
                };
                if (!updatedQuestion.title || !updatedQuestion.choices || !updatedQuestion.answer) {
                    alert('å•é¡Œæ–‡ã€é¸æŠè‚¢ã€æ­£è§£ã¯å¿…é ˆã§ã™ã€‚');
                    return;
                }

                try {
                    const response = await fetch(`/api/quiz/questions/${questionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedQuestion),
                    });
                    if (response.ok) {
                        alert('å•é¡ŒãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
                        navigate('/q_list');
                    } else if (response.status === 401 || response.status === 403) {
                        alert('èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                        Auth.logout();
                    } else {
                        const data = await response.json();
                        alert('å•é¡Œã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                } catch (err) {
                    alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
                    console.error('Error updating question:', err);
                }
            };

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œç·¨é›†</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="editQuestionForm">
                        <div class="form-group">
                            <label>å•é¡Œç•ªå·ï¼š</label>
                            <input type="text" class="form-control" name="Q_no" value="${question.Q_no !== null ? question.Q_no : ''}" readonly />
                        </div>
                        <div class="form-group">
                            <label>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label>
                            <input type="text" class="form-control" name="genre" value="${question.genre}" required />
                        </div>
                        <div class="form-group">
                            <label>å•é¡Œæ–‡ï¼š</label>
                            <textarea class="form-control" name="title" rows="3" required>${question.title}</textarea>
                        </div>
                        <div class="form-group">
                            <label>é¸æŠè‚¢ (ä¾‹: é¸1:é¸2:é¸3):</label>
                            <input type="text" class="form-control" name="choices" value="${question.choices}" required />
                        </div>
                        <div class="form-group">
                            <label>æ­£è§£ (ä¾‹: é¸1:é¸2):</label>
                            <input type="text" class="form-control" name="answer" value="${question.answer}" required />
                        </div>
                        <div class="form-group">
                            <label>è§£èª¬ï¼š</label>
                            <textarea class="form-control" name="explanation" rows="5">${question.explanation}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3 btn-block">ä¿å­˜</button>
                    </form>
                    <div class="mt-3 text-center">
                        <a href="/q_list" id="backToListLink" class="btn btn-secondary">æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
            render(html);

            document.getElementById('editQuestionForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', (e) => {
                e.preventDefault();
                navigate('/q_list');
            });
        }

        // FirstQuestion ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderFirstQuestion(state) {
            console.log('RENDERFIRSTQUESTION: Function called with state:', state);
            if (!Auth.isAuthenticated()) { // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
                navigate('/login');
                return;
            }
            const { category, nanko } = state || {};
            if (!category || !nanko) {
                alert('ã‚¯ã‚¤ã‚ºè¨­å®šãŒä¸æ­£ã§ã™ã€‚');
                navigate('/genre');
                return;
            }

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ã“ã‚Œã‹ã‚‰å•é¡Œã‚’å§‹ã‚ã¾ã™</h1>
                    <h2 class="text-center">ã‚¸ãƒ£ãƒ³ãƒ«: <span class="badge badge-secondary">${category}</span></h2>
                    <p class="text-center lead">${nanko}å•å‡ºé¡Œã•ã‚Œã¾ã™ã€‚</p>
                    <div class="text-center mt-5">
                        <button id="startQuizButton" class="btn btn-success btn-lg">ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹</button>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/genre" class="btn btn-link">ã‚¯ã‚¤ã‚ºè¨­å®šã«æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
            render(html);
            
            document.getElementById('startQuizButton').addEventListener('click', () => {
                navigate('/question', { category, nanko });
            });
        }

        // Genre ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        async function renderGenre() {
            console.log('RENDERGENRE: Function called.');
            if (!Auth.isAuthenticated()) { // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
                navigate('/login');
                return;
            }
            let genres = {};
            let selectedGenre = '';
            let numQuestions = 1;
            let error = '';
            const token = Auth.token;

            try {
                const response = await fetch('/api/quiz/genres', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    genres = await response.json();
                    if (Object.keys(genres).length > 0) {
                        selectedGenre = Object.keys(genres)[0]; // æœ€åˆã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠ
                    }
                } else if (response.status === 401 || response.status === 403) {
                    error = 'èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
                    Auth.logout();
                } else {
                    const data = await response.json();
                    error = data.message || 'ã‚¸ãƒ£ãƒ³ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                }
            } catch (err) {
                error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
                console.error('Error fetching genres:', err);
            }

            const handleSubmit = (event) => {
                event.preventDefault();
                if (!selectedGenre) {
                    alert("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                const maxTopics = genres[selectedGenre] ? genres[selectedGenre].length : 0;
                // inputã‹ã‚‰å€¤ã‚’å–å¾—ã—ç›´ã™
                const numQuestionsInputVal = parseInt(document.getElementById('numQuestionsInput').value, 10);
                if (isNaN(numQuestionsInputVal) || numQuestionsInputVal < 1 || numQuestionsInputVal > maxTopics) {
                    alert(`å‡ºé¡Œæ•°ã¯1ä»¥ä¸Šã€é¸æŠã—ãŸã‚¸ãƒ£ãƒ³ãƒ«ã®å•é¡Œæ•° (${maxTopics}) ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return false;
                }
                numQuestions = numQuestionsInputVal; // ç¢ºå®šã—ãŸå€¤ã§æ›´æ–°
                
                currentQuizConfig = { category: selectedGenre, nanko: numQuestions };
                navigate('/firstquestion', { category: selectedGenre, nanko: numQuestions });
            };

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ã‚¯ã‚¤ã‚ºè¨­å®š</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    ${Object.keys(genres).length > 0 ? `
                        <form id="genreForm">
                            <h3 class="mb-3">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ:</h3>
                            <ul class="list-group mb-4">
                                ${Object.entries(genres).map(([genre, ids]) => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="form-check">
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="category"
                                                id="genre-${genre}"
                                                value="${genre}"
                                                data-length="${ids.length}"
                                                ${selectedGenre === genre ? 'checked' : ''}
                                            />
                                            <label class="form-check-label" for="genre-${genre}">
                                                <strong>${genre}</strong>
                                            </label>
                                        </div>
                                        <span class="badge badge-primary badge-pill">${ids.length}å•</span>
                                    </li>
                                `).join('')}
                            </ul>
                            <div class="form-group">
                                <label for="numQuestionsInput">å‡ºé¡Œæ•° (1 - <span id="maxQuestions">${genres[selectedGenre] ? genres[selectedGenre].length : 0}</span>):</label>
                                <input type="number" class="form-control" id="numQuestionsInput" name="nanko" value="${numQuestions}" min="1" max="${genres[selectedGenre] ? genres[selectedGenre].length : 0}" />
                            </div>
                            <button type="submit" class="btn btn-primary btn-block mt-4">ã‚¯ã‚¤ã‚ºè¨­å®šã‚’é€ä¿¡</button>
                        </form>
                    ` : '<p class="text-center">ã‚¸ãƒ£ãƒ³ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>'}
                    <div class="text-center mt-3">
                        <a href="/admin" class="btn btn-link">ç®¡ç†è€…ç”»é¢ã¸æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
            render(html);

            if (Object.keys(genres).length > 0) {
                const genreForm = document.getElementById('genreForm');
                const numQuestionsInput = document.getElementById('numQuestionsInput');
                const maxQuestionsSpan = document.getElementById('maxQuestions');

                if (genreForm && numQuestionsInput && maxQuestionsSpan) {
                    // åˆæœŸé¸æŠã‚¸ãƒ£ãƒ³ãƒ«ã®æœ€å¤§å€¤ã‚’åæ˜ 
                    maxQuestionsSpan.textContent = genres[selectedGenre] ? genres[selectedGenre].length : 0;
                    numQuestionsInput.max = genres[selectedGenre] ? genres[selectedGenre].length : 0;
                    numQuestionsInput.value = numQuestions; // ç¾åœ¨ã®numQuestionsã‚’UIã«åæ˜ 

                    genreForm.addEventListener('submit', handleSubmit);
                    document.querySelectorAll('input[name="category"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            selectedGenre = e.target.value;
                            const newMaxLength = parseInt(e.target.dataset.length, 10);
                            
                            maxQuestionsSpan.textContent = newMaxLength; // UIä¸Šã®æœ€å¤§å€¤è¡¨ç¤ºã‚’æ›´æ–°
                            numQuestionsInput.max = newMaxLength; // inputã®maxå±æ€§ã‚’æ›´æ–°
                            
                            // ç¾åœ¨ã®numQuestionsãŒæ–°ã—ã„maxã‚’è¶…ãˆã¦ã„ãŸã‚‰èª¿æ•´
                            if (parseInt(numQuestionsInput.value, 10) > newMaxLength) {
                                numQuestionsInput.value = newMaxLength;
                            }
                        });
                    });
                    // å‡ºé¡Œæ•°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
                    numQuestionsInput.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value, 10);
                        const maxVal = parseInt(e.target.max, 10);
                        if (isNaN(val) || val < 1) {
                            e.target.value = 1;
                        } else if (val > maxVal) {
                            e.target.value = maxVal;
                        }
                    });
                }
            }
        }


        // Kekka (çµæœ) ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderKekka(state) {
            console.log('RENDERKEKKA: Function called with state:', state);
            if (!Auth.isAuthenticated()) { 
                navigate('/login');
                return;
            }
            const { resultData, selectedChoices, correctAnswers, questionData } = state || {};

            if (!resultData || !questionData) {
                render(`<div class="container"><div class="error-message">çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¯ã‚¤ã‚ºã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚</div><div class="text-center mt-3"><a href="/genre" class="btn btn-primary">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã«æˆ»ã‚‹</a></div></div>`);
                return;
            }

            const correctAnsSet = new Set(correctAnswers.map(c => c.trim()).filter(c => c !== '')); // æ­£è§£ã‹ã‚‰ç©ºæ–‡å­—åˆ—ã‚’é™¤å»
            const choicesArray = questionData.choices.split(':').map(c => c.trim()).filter(c => c !== ''); // é¸æŠè‚¢ã‹ã‚‰ç©ºæ–‡å­—åˆ—ã‚’é™¤å»
            const answerFeedback = {};

            choicesArray.forEach(choice => {
                if (selectedChoices.map(c => c.trim()).includes(choice)) { // é¸æŠè‚¢ã‚’ãƒˆãƒªãƒ ã—ã¦æ¯”è¼ƒ
                    answerFeedback[choice] = correctAnsSet.has(choice) ? 'âœ…' : 'âŒ';
                } else {
                    answerFeedback[choice] = correctAnsSet.has(choice) ? 'â­•' : '-'; 
                }
            });

            const isLastQuestion = currentQuestionIndex >= currentQuestions.length - 1;
            const nextButtonText = isLastQuestion ? 'ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã™ã‚‹' : 'æ¬¡ã®å•é¡Œã¸';

            const html = `
                <div class="container">
                    <div class="card-header text-center p-3 mb-3 bg-primary text-white">
                        <h3 class="mb-0">å•é¡Œ ${questionData.Q_no !== null ? questionData.Q_no : questionData.rowid}</h3>
                    </div>
                    <div class="card-body">
                        <div style="color: ${resultData.answer.includes('æ­£è§£') ? 'green' : 'red'}; font-size: 2em; font-weight: bold; text-align: center; margin-top: 20px;">
                            <p>${resultData.answer.includes('æ­£è§£') ? 'ğŸ‰ æ­£è§£ï¼' : 'æ®‹å¿µï¼ä¸æ­£è§£...'}</p>
                        </div>
                        <table class="table table-bordered mt-3">
                            <thead>
                                <tr>
                                    <th>é¸æŠè‚¢</th>
                                    <th>åˆ¤å®š</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${choicesArray.map((choice, index) => `
                                    <tr key="${index}">
                                        <td>${choice}</td>
                                        <td>${answerFeedback[choice]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p>ã‚ãªãŸã®é¸æŠ: ${selectedChoices.length > 0 ? selectedChoices.join(', ') : 'ãªã—'}</p>
                        <p>æ­£è§£: ${correctAnswers.join(', ')}</p>
                        ${questionData.explanation ? `
                            <h4 class="mt-4">è§£èª¬</h4>
                            <p>${questionData.explanation}</p>
                        ` : ''}
                        <p class="text-muted">çµŒéæ™‚é–“: ${parseFloat(resultData.elapsed_time).toFixed(2)}ç§’</p>

                        <div class="d-flex justify-content-between mt-4">
                            <button id="nextQuestionButton" class="btn btn-primary btn-lg">${nextButtonText}</button>
                            <button id="viewResultsButton" class="btn btn-secondary btn-lg">ãƒ†ã‚¹ãƒˆçµæœä¸€è¦§ã¸</button>
                        </div>
                    </div>
                </div>
            `;
            render(html);

            document.getElementById('nextQuestionButton').addEventListener('click', () => {
                if (isLastQuestion) {
                    alert('ã™ã¹ã¦ã®å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸï¼'); 
                    navigate('/genre'); 
                } else {
                    currentQuestionIndex++; 
                    navigate('/question', { 
                        category: currentQuizConfig.category, 
                        nanko: currentQuizConfig.nanko,
                    });
                }
            });

            document.getElementById('viewResultsButton').addEventListener('click', () => {
                // â˜…å¤‰æ›´: Auth.isAdmin() ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
                if (Auth.isAdmin()) {
                    navigate('/view');
                } else {
                    alert('çµæœä¸€è¦§ã¯ç®¡ç†è€…ã®ã¿é–²è¦§å¯èƒ½ã§ã™ã€‚');
                    navigate('/genre'); 
                }
            });
        }

        // View (çµæœä¸€è¦§) ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        async function renderView() {
            console.log('RENDERVIEW: Function called.');
            // â˜…å¤‰æ›´: Auth.isAdmin() ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
            if (!Auth.isAdmin()) {
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre');
                return;
            }

            let results = {};
            let error = '';

            const token = Auth.token; 
            if (!token) { // isAdmin()ã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã ãŒå¿µã®ãŸã‚
                console.warn('RENDERVIEW: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
                navigate('/login'); 
                return;
            }

            try {
                const response = await fetch('/api/admin/results', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                });
                const responseText = await response.text(); 
                try {
                    // ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚„æœ‰åŠ¹ãªJSONã§ãªã„å ´åˆã‚’è€ƒæ…®
                    if (responseText) {
                        results = JSON.parse(responseText); 
                        console.log('RENDERVIEW: API Response Data:', results); 
                    } else {
                        results = {}; // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã®å ´åˆ
                        error = 'APIã‹ã‚‰ã®çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    }
                } catch (jsonError) {
                    error = 'APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒä¸æ­£ã§ã™ã€‚';
                    console.error('RENDERVIEW: JSON parse error:', jsonError, 'Response Text:', responseText);
                    results = {}; 
                }

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        error = 'èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
                        Auth.logout(); 
                    } else {
                        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰messageãŒæä¾›ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†
                        if (results && results.message) {
                            error = results.message;
                        } else if (response.status === 500) {
                            error = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${response.status})ã€‚`;
                        } else {
                            error = `çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`;
                        }
                    }
                } else if (Object.keys(results).length === 0 && !error) {
                    error = 'è¡¨ç¤ºã§ãã‚‹ãƒ†ã‚¹ãƒˆçµæœãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚'; 
                }

            } catch (err) {
                error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: ' + err.message;
                console.error('RENDERVIEW: Error fetching results:', err);
            }

            const chartDataByUser = {};

            if (Object.keys(results).length > 0) {
                for (const userName in results) {
                    const userGenres = results[userName];
                    const labels = [];
                    const accuracies = [];
                    const backgroundColors = [];
                    const borderColors = [];

                    for (const genre in userGenres) {
                        const data = userGenres[genre];
                        if (typeof data.correct === 'number' && typeof data.total === 'number' && data.total > 0) {
                            const accuracy = parseFloat(((data.correct / data.total) * 100).toFixed(2));
                            labels.push(genre);
                            accuracies.push(accuracy);

                            if (accuracy >= 80) {
                                backgroundColors.push('rgba(75, 192, 192, 0.6)'); 
                                borderColors.push('rgba(75, 192, 192, 1)');
                            } else if (accuracy >= 50) {
                                backgroundColors.push('rgba(255, 206, 86, 0.6)'); 
                                borderColors.push('rgba(255, 206, 86, 1)');
                            } else {
                                backgroundColors.push('rgba(255, 99, 132, 0.6)'); 
                                borderColors.push('rgba(255, 99, 132, 1)');
                            }
                        }
                    }
                    if (labels.length > 0) { 
                        chartDataByUser[userName] = {
                            labels: labels,
                            accuracies: accuracies,
                            backgroundColors: backgroundColors,
                            borderColors: borderColors
                        };
                    }
                }
            }

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">æ­£ç­”ç‡ã®çµæœ</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    
                    <div class="mt-4">
                        <h2 class="text-center mb-3">åå‰ã¨ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡</h2>
                        ${Object.keys(results).length > 0 ? `
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                        <th>ã‚¸ãƒ£ãƒ³ãƒ«</th>
                                        <th>æ­£ç­”ç‡</th>
                                        <th>æ­£è§£æ•°</th>
                                        <th>ç·å•é¡Œæ•°</th>
                                        <th>é–“é•ãˆãŸå•é¡ŒID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(results).map(([name, genres]) => (
                                        Object.entries(genres).map(([genre, data]) => {
                                            if (typeof data.correct === 'number' && typeof data.total === 'number') {
                                                const accuracy = ((data.correct / data.total) * 100 || 0).toFixed(2);
                                                const errorQuestions = data.error && Array.isArray(data.error) && data.error.length > 0
                                                    ? data.error.map((questionId, index) => `
                                                        <span>
                                                            <a href="/admin/retry/${questionId}" data-id="${questionId}" data-genre="${genre}" class="retry-link btn btn-sm btn-outline-danger m-1">${questionId}</a>${index < data.error.length - 1 ? '' : ''}
                                                        </span>
                                                    `).join('')
                                                    : 'ãªã—';
                                                
                                                return `
                                                    <tr key="${name}-${genre}">
                                                        <td>${name}</td>
                                                        <td>${genre}</td>
                                                        <td>${accuracy}%</td>
                                                        <td>${data.correct}</td>
                                                        <td>${data.total}</td>
                                                        <td>${errorQuestions}</td>
                                                    </tr>
                                                `;
                                            } else {
                                                console.warn(`RENDERVIEW: Invalid data format for ${name}-${genre}:`, data);
                                                return `<tr><td colspan="6" class="text-danger">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™ (${name} - ${genre})</td></tr>`;
                                            }
                                        }).join('')
                                    )).join('')}
                                </tbody>
                            </table>
                        ` : (error ? '' : '<p class="text-center">ãƒ†ã‚¹ãƒˆçµæœãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>')}
                    </div>

                    <h2 class="mt-5 text-center mb-3">ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡ã‚°ãƒ©ãƒ•</h2>
                    ${Object.keys(chartDataByUser).length > 0 ? `
                        ${Object.entries(chartDataByUser).map(([userName, data]) => `
                            <div class="chart-container">
                                <h3 class="text-center mb-3">${userName}ã•ã‚“ã®ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡</h3>
                                <canvas id="accuracyChart-${userName}"></canvas>
                            </div>
                        `).join('')}
                    ` : '<p class="text-center">ã‚°ãƒ©ãƒ•è¡¨ç¤ºã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}

                    <div class="text-center mt-4">
                        <a href="/admin" class="btn btn-secondary btn-lg">ç®¡ç†è€…ç”»é¢ã¸æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
            render(html);

            document.querySelectorAll('.retry-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const questionId = e.target.dataset.id;
                    const genre = e.target.dataset.genre; // genreæƒ…å ±ã‚’æ¸¡ã™
                    navigate(`/admin/retry/${questionId}`, { genre: genre, resetQuiz: true }); // resetQuizã‚‚æ¸¡ã™
                });
            });

            if (Object.keys(chartDataByUser).length > 0) {
                for (const userName in chartDataByUser) {
                    const data = chartDataByUser[userName];
                    const ctx = document.getElementById(`accuracyChart-${userName}`);
                    if (ctx) { 
                        new Chart(ctx, {
                            type: 'bar', 
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: 'æ­£ç­”ç‡ (%)',
                                    data: data.accuracies,
                                    backgroundColor: data.backgroundColors,
                                    borderColor: data.borderColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true, 
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${userName}ã•ã‚“ã®ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡` 
                                    },
                                    legend: {
                                        display: false 
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true, 
                                        max: 100, 
                                        title: {
                                            display: true,
                                            text: 'æ­£ç­”ç‡ (%)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%'; // Yè»¸ã®ç›®ç››ã‚Šã« '%' ã‚’è¿½åŠ 
                                            }
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'ã‚¸ãƒ£ãƒ³ãƒ«'
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }
        }

        // CreateQuiz ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        function renderCreateQuiz() {
            console.log('RENDERCREATEQUIZ: Function called.');
            if (!Auth.isAdmin()) {
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre');
                return;
            }
            let error = '';
            const token = Auth.token;

            const handleSubmit = async (event) => {
                event.preventDefault();
                error = '';

                const newQuestion = {
                    genre: event.target.genre.value,
                    title: event.target.title.value,
                    choices: event.target.choices.value,
                    answer: event.target.answer.value,
                    explanation: event.target.explanation.value,
                };

                if (!newQuestion.genre || !newQuestion.title || !newQuestion.choices || !newQuestion.answer) {
                    error = 'ã‚¸ãƒ£ãƒ³ãƒ«ã€å•é¡Œæ–‡ã€é¸æŠè‚¢ã€æ­£è§£ã¯å¿…é ˆã§ã™ã€‚'; // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼·åŒ–
                    renderCreateQuiz(error); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    return;
                }

                try {
                    const response = await fetch('/api/quiz/questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(newQuestion),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('å•é¡ŒãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼');
                        navigate('/q_list');
                    } else if (response.status === 401 || response.status === 403) {
                        alert('èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                        Auth.logout();
                    } else {
                        error = data.message || 'å•é¡Œã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    }
                } catch (err) {
                    error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
                    console.error('Error creating question:', err);
                }
                renderCreateQuiz(error); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ãŸã‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            };

            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œä½œæˆ</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="createQuizForm">
                        <div class="form-group">
                            <label for="genre">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label>
                            <input type="text" class="form-control" id="genre" name="genre" required />
                        </div>
                        <div class="form-group">
                            <label for="title">å•é¡Œæ–‡ï¼š</label>
                            <textarea class="form-control" id="title" name="title" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="choices">é¸æŠè‚¢ (ä¾‹: é¸1:é¸2:é¸3):</label>
                            <input type="text" class="form-control" id="choices" name="choices" placeholder="é¸æŠè‚¢ã‚’ã‚³ãƒ­ãƒ³ ':' ã§åŒºåˆ‡ã£ã¦å…¥åŠ›" required />
                        </div>
                        <div class="form-group">
                            <label for="answer">æ­£è§£ (ä¾‹: é¸1:é¸2):</label>
                            <input type="text" class="form-control" id="answer" name="answer" placeholder="æ­£è§£ã‚’ã‚³ãƒ­ãƒ³ ':' ã§åŒºåˆ‡ã£ã¦å…¥åŠ›" required />
                        </div>
                        <div class="form-group">
                            <label for="explanation">è§£èª¬ï¼š</label>
                            <textarea class="form-control" id="explanation" name="explanation" rows="5"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">å•é¡Œã‚’ä½œæˆ</button>
                    </form>
                    <div class="mt-3 text-center">
                        <a href="/q_list" id="backToListLink" class="btn btn-secondary">å•é¡Œä¸€è¦§ã¸æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
            render(html);

            document.getElementById('createQuizForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', (e) => {
                e.preventDefault();
                navigate('/q_list');
            });
        }


        // Question ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (å†…éƒ¨çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®å·¥å¤«ãŒå¿…è¦)
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedChoices = [];
        let quizStartTime = null;
        // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã®ã‚¸ãƒ£ãƒ³ãƒ«ã¨å•é¡Œæ•°ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentQuizConfig = { category: '', nanko: 0 }; 

        async function renderQuestion(state) {
            console.log('RENDERQUESTION: Function called with state:', state);
            if (!Auth.isAuthenticated()) { 
                navigate('/login');
                return;
            }
            const { category, nanko } = state || {};
            let error = '';
            const token = Auth.token;

            if (!category || !nanko) {
                error = 'ã‚¯ã‚¤ã‚ºã®ã‚¸ãƒ£ãƒ³ãƒ«ã¾ãŸã¯å•é¡Œæ•°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                render(`<div class="container error-message">${error}<p><a href="/genre">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã«æˆ»ã‚‹</a></p></div>`);
                return;
            }

            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯ã‚¸ãƒ£ãƒ³ãƒ«ã‚„å•é¡Œæ•°ãŒå¤‰ã‚ã£ãŸå ´åˆã€
            // ã¾ãŸã¯æ˜ç¤ºçš„ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹å ´åˆï¼ˆä¾‹: ãƒªãƒˆãƒ©ã‚¤æ™‚ï¼‰ã®ã¿å•é¡Œã‚’ãƒ•ã‚§ãƒƒãƒ
            // state.resetQuiz ã¯ handleRetryQuestion ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹æƒ³å®š
            if (currentQuestions.length === 0 || 
                category !== currentQuizConfig.category || 
                nanko !== currentQuizConfig.nanko ||
                state.resetQuiz) { 
                console.log('RENDERQUESTION: Fetching new questions...');
                try {
                    // /admin/retry ã‹ã‚‰æ¥ãŸå ´åˆã¯ã€state.resetQuiz ãŒ true ã§ã€ã‹ã¤ state.questionId ãŒã‚ã‚‹ã€‚
                    // ãã®å ´åˆã¯ get_random_questions ã§ã¯ãªãã€ç‰¹å®šã®è³ªå•ã‚’ç›´æ¥ä½¿ç”¨ã€‚
                    let questionsToLoad = [];
                    if (state.resetQuiz && state.questionId && state.retriedQuestionData) {
                        questionsToLoad = [state.retriedQuestionData];
                        currentQuizConfig = { category: state.retriedQuestionData.genre_name || category, nanko: 1 };
                        console.log('RENDERQUESTION: Using retried question data directly.');
                    } else {
                        const response = await fetch(`/api/quiz/get_random_questions?genre=${category}&count=${nanko}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const data = await response.json();
                        if (response.ok) {
                            questionsToLoad = data;
                            if (questionsToLoad.length === 0) {
                                error = 'æŒ‡å®šã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                                render(`<div class="container error-message">${error}<p><a href="/genre">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã«æˆ»ã‚‹</a></p></div>`);
                                return;
                            }
                            currentQuizConfig = { category, nanko }; // è¨­å®šã‚’æ›´æ–°
                            console.log('RENDERQUESTION: Fetched random questions successfully.');
                        } else if (response.status === 401 || response.status === 403) {
                            error = 'èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
                            Auth.logout();
                            return;
                        } else {
                            error = data.message || 'å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                            render(`<div class="container error-message">${error}<p><a href="/genre">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã«æˆ»ã‚‹</a></p></div>`);
                            return;
                        }
                    }
                    currentQuestions = questionsToLoad;
                    currentQuestionIndex = 0; // æ–°ã—ã„ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
                } catch (err) {
                    error = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
                    console.error('Error fetching questions:', err);
                    render(`<div class="container error-message">${error}<p><a href="/genre">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã«æˆ»ã‚‹</a></p></div>`);
                    return;
                }
            }

            // ã“ã“ã§ currentQuestionIndex ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€å•é¡ŒãŒã¾ã ã‚ã‚‹ã‹ç¢ºèª
            if (currentQuestionIndex >= currentQuestions.length) {
                console.log("RENDERQUESTION: No more questions. Navigating to final summary or genre page.");
                alert('ã™ã¹ã¦ã®å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸï¼ã‚¯ã‚¤ã‚ºçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); 
                navigate('/genre'); 
                return;
            }

            const currentQuestion = currentQuestions[currentQuestionIndex];
            selectedChoices = []; // å„å•é¡Œã®é–‹å§‹æ™‚ã«é¸æŠè‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            quizStartTime = new Date(); // å„å•é¡Œã®é–‹å§‹æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ

            const choices = currentQuestion.choices.split(':').filter(c => c.trim() !== ''); // ç©ºã®é¸æŠè‚¢ã‚’é™¤å¤–

            const handleChoiceChange = (event) => {
                const choice = event.target.value;
                if (event.target.checked) {
                    selectedChoices.push(choice);
                } else {
                    selectedChoices = selectedChoices.filter(c => c !== choice);
                }
                console.log("Selected choices updated:", selectedChoices); 
            };

            const handleSubmitAnswer = async () => {
                if (selectedChoices.length === 0) {
                    alert('é¸æŠè‚¢ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚');
                    return;
                }

                const correctAnswers = (currentQuestion.correct_ans || currentQuestion.answer).split(':').filter(c => c.trim() !== '');
                const username = Auth.username || 'Guest';
                
                // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: toISOString() ã‚’ä½¿ã£ã¦UTCåŸºæº–ã®ISO 8601å½¢å¼ã§é€ä¿¡ â˜…â˜…â˜…
                const startDatetimeISO = quizStartTime.toISOString();

                const payload = {
                    user_choice: selectedChoices,
                    correct_ans: correctAnswers,
                    start_datetime: startDatetimeISO,
                    username: username,
                    genre: currentQuestion.genre_name || currentQuestion.genre, // APIã‹ã‚‰ã®genre_nameã‚’å„ªå…ˆ
                    qmap: currentQuestion.Q_no,
                    question_id: currentQuestion.question_id || currentQuestion.rowid, // APIã‹ã‚‰ã®question_idã‚’å„ªå…ˆ
                    kaisetsu: currentQuestion.kaisetsu || currentQuestion.explanation
                };

                try {
                    const response = await fetch('/api/quiz/check_answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify(payload),
                    });
                    const resultData = await response.json();

                    selectedChoices = []; 

                    navigate('/kekka', {
                        resultData: resultData,
                        selectedChoices: payload.user_choice, 
                        correctAnswers: correctAnswers,
                        questionData: currentQuestion // å…ƒã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾æ¸¡ã™
                    });

                } catch (err) {
                    alert('è§£ç­”é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
                    console.error('Error submitting answer:', err);
                }
            };

            // ã“ã“ã‹ã‚‰DOMã‚’ç›´æ¥æ§‹ç¯‰
            const containerDiv = document.createElement('div');
            containerDiv.className = 'container';

            const h1 = document.createElement('h1');
            h1.className = 'text-center mb-4';
            h1.textContent = 'ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼';
            containerDiv.appendChild(h1);

            const cardDiv = document.createElement('div');
            cardDiv.className = 'card mt-4';
            containerDiv.appendChild(cardDiv);

            const cardHeaderDiv = document.createElement('div');
            cardHeaderDiv.className = 'card-header bg-info text-white';
            cardHeaderDiv.innerHTML = `
                <h5 class="mb-0">å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuestions.length}</h5>
                <p class="mb-0">ã‚¸ãƒ£ãƒ³ãƒ«: ${currentQuestion.genre_name || currentQuestion.genre}</p>
            `;
            cardDiv.appendChild(cardHeaderDiv);

            const cardBodyDiv = document.createElement('div');
            cardBodyDiv.className = 'card-body';
            cardDiv.appendChild(cardBodyDiv);

            const h4 = document.createElement('h4');
            h4.className = 'card-title mb-4';
            h4.textContent = currentQuestion.title || currentQuestion.question; // ãƒªãƒˆãƒ©ã‚¤æ™‚ã® 'question' ã«å¯¾å¿œ
            cardBodyDiv.appendChild(h4);

            const choicesContainerDiv = document.createElement('div');
            choicesContainerDiv.className = 'form-group';
            choicesContainerDiv.id = 'choicesContainer'; 
            cardBodyDiv.appendChild(choicesContainerDiv);

            choices.forEach((choice, index) => {
                const formCheckDiv = document.createElement('div');
                formCheckDiv.className = 'form-check';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'form-check-input';
                input.id = `choice-${index}`;
                input.value = choice;
                if (selectedChoices.includes(choice)) { 
                    input.checked = true;
                }
                input.addEventListener('change', handleChoiceChange);

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `choice-${index}`;
                label.textContent = choice;

                formCheckDiv.appendChild(input);
                formCheckDiv.appendChild(label);
                choicesContainerDiv.appendChild(formCheckDiv);
            });

            const submitButton = document.createElement('button');
            submitButton.id = 'submitAnswerButton';
            submitButton.className = 'btn btn-primary mt-4 btn-lg btn-block';
            submitButton.textContent = 'è§£ç­”ã™ã‚‹';
            submitButton.addEventListener('click', handleSubmitAnswer);
            cardBodyDiv.appendChild(submitButton);

            document.getElementById('root').innerHTML = ''; 
            document.getElementById('root').appendChild(containerDiv);
        }

        // --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---
        function handleRouting() {
            const path = window.location.pathname;
            const state = history.state; 
            console.log('HANDLEROUTING: Function called for path:', path, 'state:', state);

            if (!Auth.isAuthenticated() && path !== '/login' && path !== '/signup') {
                console.log('HANDLEROUTING: Not authenticated, redirecting to login.');
                navigate('/login');
                return; 
            }

            switch (path) {
                case '/login':
                case '/': 
                    console.log('HANDLEROUTING: Path is / or /login, rendering Login.');
                    if (Auth.isAuthenticated()) { // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã¯è¡Œã‹ã›ãªã„
                        if (Auth.isAdmin()) {
                            navigate('/admin');
                        } else {
                            navigate('/genre');
                        }
                        return; 
                    }
                    renderLogin(state ? state.error : ''); // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’æ¸¡ã™
                    break;
                case '/signup':
                    console.log('HANDLEROUTING: Path is /signup, rendering Signup.');
                    if (Auth.isAuthenticated()) { // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã¯è¡Œã‹ã›ãªã„
                        if (Auth.isAdmin()) {
                            navigate('/admin');
                        } else {
                            navigate('/genre');
                        }
                        return;
                    }
                    renderSignup(state ? state.error : ''); // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’æ¸¡ã™
                    break;
                case '/admin':
                    console.log('HANDLEROUTING: Path is /admin, rendering Admin.');
                    renderAdmin(); // renderAdminå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
                    break;
                case '/q_list':
                    console.log('HANDLEROUTING: Path is /q_list, rendering QuestionList.');
                    renderQuestionList(); // renderQuestionListå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
                    break;
                case '/createquiz':
                    console.log('HANDLEROUTING: Path is /createquiz, rendering CreateQuiz.');
                    renderCreateQuiz(); // renderCreateQuizå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
                    break;
                case '/genre':
                    console.log('HANDLEROUTING: Path is /genre, rendering Genre.');
                    renderGenre();
                    break;
                case '/firstquestion':
                    console.log('HANDLEROUTING: Path is /firstquestion, rendering FirstQuestion.');
                    renderFirstQuestion(state);
                    break;
                case '/question':
                    console.log('HANDLEROUTING: Path is /question, rendering Question.');
                    renderQuestion(state);
                    break;
                case '/kekka':
                    console.log('HANDLEROUTING: Path is /kekka, rendering Kekka.');
                    renderKekka(state);
                    break;
                case '/view':
                    console.log('HANDLEROUTING: Path is /view, rendering View.');
                    renderView(); // renderViewå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
                    break;
                default:
                    if (path.startsWith('/edit/')) {
                        const questionId = path.split('/')[2];
                        if (questionId) {
                            console.log('HANDLEROUTING: Path is /edit/:id, rendering EditQuestion for ID:', questionId);
                            renderEditQuestion(questionId); // renderEditQuestionå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
                        } else {
                            console.log('HANDLEROUTING: Invalid /edit/ path.');
                            render(`<div>404 Not Found</div>`);
                        }
                    } else if (path.startsWith('/admin/retry/')) {
                        const questionId = path.split('/')[3];
                        if (questionId && state && state.retriedQuestionData) {
                            console.log('HANDLEROUTING: Path is /admin/retry/:id, rendering Question with retried data for ID:', questionId);
                            renderQuestion(state); // renderQuestionå†…ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                        } else {
                            console.log('HANDLEROUTING: Invalid /admin/retry/ path or missing data in state.');
                            navigate('/view'); 
                        }
                    }
                    else {
                        console.log('HANDLEROUTING: Default (404) for path:', path);
                        render(`<div>404 Not Found</div>`);
                    }
                    break;
            }
        }

        // handleRetryQuestion ã¯APIå‘¼ã³å‡ºã—ã¨navigateã®å½¹å‰²ã‚’æŒã¤
        async function handleRetryQuestion(questionId, genre) {
            console.log('HANDLERETRYQUESTION: Function called for ID:', questionId, 'genre:', genre);
            if (!Auth.isAdmin()) { // æ¨©é™ãƒã‚§ãƒƒã‚¯
                alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                navigate('/genre');
                return;
            }

            const token = Auth.token;
            if (!token) { // ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯
                console.warn('HANDLERETRYQUESTION: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
                navigate('/login');
                return;
            }

            try {
                const response = await fetch(`/api/admin/retry/${questionId}${genre ? `?genre=${genre}` : ''}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('Retried question data:', data);
                    // å–å¾—ã—ãŸå•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’history.stateã«å«ã‚ã¦/questionã«é·ç§»
                    navigate('/question', { 
                        category: genre, 
                        nanko: 1, // ãƒªãƒˆãƒ©ã‚¤ãªã®ã§å¸¸ã«1å•
                        resetQuiz: true, // Questionã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã•ã›ã‚‹æŒ‡ç¤º
                        questionId: questionId, // ãƒªãƒˆãƒ©ã‚¤ã—ãŸå•é¡Œã®ID
                        retriedQuestionData: data // å–å¾—ã—ãŸå•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥æ¸¡ã™
                    });

                } else {
                    if (response.status === 401 || response.status === 403) {
                        alert('èªè¨¼ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                        Auth.logout();
                    } else {
                        alert('å•é¡Œã®å†è©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.description || data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                        console.error('Error retry_question API:', data);
                    }
                    navigate('/view'); 
                }
            } catch (error) {
                alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: å•é¡Œã‚’å†è©¦è¡Œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' + error.message);
                console.error('Error retrying question:', error);
                navigate('/view'); 
            }
        }


        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¨å±¥æ­´å¤‰æ›´æ™‚ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‡¦ç†
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);
    </script>
</body>
</html>