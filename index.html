<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .error-message { color: red; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .success-message { color: green; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .signup-link, .login-link { text-align: center; margin-top: 15px; }
        .signup-link a, .login-link a { color: #4CAF50; }
        .tab { text-align: center; margin-top: 50px; }
        .tab button { margin: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #e9ecef; font-weight: bold; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e6e6e6; }
        .chart-container { width: 90%; margin: 40px auto; background-color: #ffffff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .form-group { margin-bottom: 1.5rem; }
        .dashboard-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .dashboard-button { padding: 2rem; font-size: 1.2rem; }
    </style>
</head>

<body>
    <div id="root"></div>
    <script>
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function render(componentHtml) {
            document.getElementById('root').innerHTML = componentHtml;
        }

        function navigate(path, state = {}) {
            if (window.location.pathname !== path || JSON.stringify(history.state) !== JSON.stringify(state)) {
                history.pushState(state, '', path);
                handleRouting();
            }
        }

        // --- èªè¨¼çŠ¶æ…‹ç®¡ç† ---
        const Auth = {
            token: localStorage.getItem('token') || null,
            username: localStorage.getItem('username') || null,
            role: localStorage.getItem('role') || null,
            setToken(newToken) { this.token = newToken; if (newToken) localStorage.setItem('token', newToken); else localStorage.removeItem('token'); },
            setUsername(newUsername) { this.username = newUsername; if (newUsername) localStorage.setItem('username', newUsername); else localStorage.removeItem('username'); },
            setRole(newRole) { this.role = newRole; if (newRole) localStorage.setItem('role', newRole); else localStorage.removeItem('role'); },
            login(newToken, newUsername, newRole) {
                this.setToken(newToken);
                this.setUsername(newUsername);
                this.setRole(newRole);
                if (newRole === 'admin') {
                    navigate('/admin');
                } else {
                    navigate('/dashboard'); 
                }
            },
            logout() {
                this.setToken(null);
                this.setUsername(null);
                this.setRole(null);
                navigate('/login');
            },
            isAuthenticated() { return this.token !== null; },
            isAdmin() { return this.isAuthenticated() && this.role === 'admin'; }
        };

        // --- å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

        function renderLogin(initialError = '') {
            let errorMessage = initialError;
            let successMessage = '';
            if (history.state && history.state.signupSuccess) {
                successMessage = 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                history.replaceState({}, '', '/login');
            }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        Auth.login(data.token, data.username, data.role);
                    } else {
                        renderLogin(data.message || 'Login failed');
                    }
                } catch (err) {
                    renderLogin('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    ${successMessage ? `<div class="success-message">${successMessage}</div>` : ''}
                    <form id="loginForm">
                        <div class="form-group"><label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label><input type="text" class="form-control" id="username" name="username" required></div>
                        <div class="form-group"><label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label><input type="password" class="form-control" id="password" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </form>
                    <div class="signup-link"><p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ <a href="/signup">æ–°è¦ç™»éŒ²</a></p></div>
                </div>`;
            render(html);
            document.getElementById('loginForm').addEventListener('submit', handleSubmit);
            document.querySelector('.signup-link a').addEventListener('click', (e) => { e.preventDefault(); navigate('/signup'); });
        }

        function renderSignup(initialError = '') {
            let errorMessage = initialError;
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                const confirmPassword = event.target.confirmPassword.value;
                if (password !== confirmPassword) {
                    renderSignup('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚'); 
                    return;
                }
                if (password.length < 6) {
                    renderSignup('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                try {
                    const response = await fetch('/api/auth/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        navigate('/login', { signupSuccess: true });
                    } else {
                        renderSignup(data.message || 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (err) {
                    renderSignup('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">æ–°è¦ç™»éŒ²</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    <form id="signupForm">
                        <div class="form-group"><label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label><input type="text" class="form-control" id="username" name="username" required></div>
                        <div class="form-group"><label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label><input type="password" class="form-control" id="password" name="password" required minlength="6"><small class="form-text text-muted">6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small></div>
                        <div class="form-group"><label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰:</label><input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required minlength="6"></div>
                        <button type="submit" class="btn btn-primary btn-block">æ–°è¦ç™»éŒ²</button>
                    </form>
                    <div class="login-link"><p>ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ <a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a></p></div>
                </div>`;
            render(html);
            document.getElementById('signupForm').addEventListener('submit', handleSubmit);
            document.querySelector('.login-link a').addEventListener('click', (e) => { e.preventDefault(); navigate('/login'); });
        }

        function renderDashboard() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center">ã‚ˆã†ã“ãã€${Auth.username}ã•ã‚“</h1>
                    <p class="text-center text-muted">æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="dashboard-button-grid">
                        <button id="startQuizBtn" class="btn btn-primary dashboard-button">ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½</button>
                        <button id="myResultsBtn" class="btn btn-info dashboard-button">è‡ªåˆ†ã®æˆç¸¾ã‚’è¦‹ã‚‹</button>
                        <button id="logoutBtn" class="btn btn-danger dashboard-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>`;
            render(html);
            document.getElementById('startQuizBtn').addEventListener('click', () => navigate('/genre'));
            document.getElementById('myResultsBtn').addEventListener('click', () => navigate('/my_results'));
            document.getElementById('logoutBtn').addEventListener('click', () => Auth.logout());
        }

        async function renderMyResults() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let myResults = {};
            let error = '';
            try {
                const response = await fetch('/api/user/my_results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error('æˆç¸¾ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                myResults = await response.json();
            } catch (err) {
                error = err.message;
            }
            const chartData = { labels: [], accuracies: [], backgroundColors: [], borderColors: [] };
            if (Object.keys(myResults).length > 0) {
                for (const genre in myResults) {
                    const data = myResults[genre];
                    if (data.total > 0) {
                        const accuracy = parseFloat(((data.correct / data.total) * 100).toFixed(2));
                        chartData.labels.push(genre);
                        chartData.accuracies.push(accuracy);
                        if (accuracy >= 80) { chartData.backgroundColors.push('rgba(75, 192, 192, 0.6)'); chartData.borderColors.push('rgba(75, 192, 192, 1)'); }
                        else if (accuracy >= 50) { chartData.backgroundColors.push('rgba(255, 206, 86, 0.6)'); chartData.borderColors.push('rgba(255, 206, 86, 1)'); }
                        else { chartData.backgroundColors.push('rgba(255, 99, 132, 0.6)'); chartData.borderColors.push('rgba(255, 99, 132, 1)'); }
                    }
                }
            } else { error = "ã¾ã è§£ç­”å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">${Auth.username}ã•ã‚“ã®æˆç¸¾</h1>
                    ${error ? `<div class="alert alert-info text-center">${error}</div>` : ''}
                    ${chartData.labels.length > 0 ? `<div class="chart-container"><h3 class="text-center mb-3">ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡</h3><canvas id="myAccuracyChart"></canvas></div>` : ''}
                    <div class="text-center mt-4"><a href="/dashboard" id="backToDashboard" class="btn btn-secondary btn-lg">ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.getElementById('backToDashboard').addEventListener('click', e => { e.preventDefault(); navigate('/dashboard'); });
            if (chartData.labels.length > 0) {
                const ctx = document.getElementById('myAccuracyChart');
                if (ctx) {
                    new Chart(ctx, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label: 'æ­£ç­”ç‡ (%)', data: chartData.accuracies, backgroundColor: chartData.backgroundColors, borderColor: chartData.borderColors, borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } } } });
                }
            }
        }
        
        function renderAdmin() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center">${Auth.username} ã®ç®¡ç†è€…ç”»é¢</h1>
                    <div class="tab">
                        <button id="testButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½</button>
                        <button id="qListButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆä¸€è¦§ãƒ»ç·¨é›†</button>
                        <button id="createQuizButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆä½œæˆ</button>
                        <button id="viewResultsButton" class="btn btn-info">ãƒ†ã‚¹ãƒˆçµæœ</button>
                        <button id="userListButton" class="btn btn-secondary">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</button>
                        <button id="logoutButton" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>`;
            render(html);
            document.getElementById('testButton').addEventListener('click', () => navigate('/genre'));
            document.getElementById('qListButton').addEventListener('click', () => navigate('/q_list'));
            document.getElementById('createQuizButton').addEventListener('click', () => navigate('/createquiz'));
            document.getElementById('viewResultsButton').addEventListener('click', () => navigate('/view'));
            document.getElementById('userListButton').addEventListener('click', () => navigate('/users'));
            document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
        }

        async function renderUserList() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let users = [];
            let error = '';
            try {
                const response = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                users = await response.json();
            } catch (err) { error = err.message; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    ${users.length > 0 ? `
                        <table class="table table-striped table-bordered">
                            <thead><tr><th>ID</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>å½¹å‰²</th><th>ç™»éŒ²æ—¥æ™‚</th></tr></thead>
                            <tbody>${users.map(user => `<tr><td>${user.id}</td><td>${user.username}</td><td><span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">${user.role}</span></td><td>${new Date(user.created_at).toLocaleString('ja-JP')}</td></tr>`).join('')}</tbody>
                        </table>` : '<p class="text-center">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</p>'}
                     <div class="text-center mt-4"><a href="/admin" id="backToAdmin" class="btn btn-secondary">ç®¡ç†è€…ç”»é¢ã«æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.getElementById('backToAdmin').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }
        
        async function renderQuestionList() {
             if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let questions = []; let error = '';
            try {
                const response = await fetch('/api/quiz/questions', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { questions = await response.json(); } else { throw new Error('Failed to fetch'); }
            } catch (err) { error = 'å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œä¸€è¦§</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <ul class="list-group">
                        ${questions.length > 0 ? questions.map(q => `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${q.Q_no || ''} | ${q.genre} | ${q.title.substring(0, 50)}...</span><button data-id="${q.rowid}" class="edit-button btn btn-sm btn-info ml-2">ç·¨é›†</button></li>`).join('') : '<li class="list-group-item">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>'}
                    </ul>
                    <div class="text-center mt-4"><a href="/createquiz" id="createQuizLink" class="btn btn-primary">å•é¡Œä½œæˆ</a> <a href="/admin" id="backToAdmin" class="btn btn-secondary">æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.querySelectorAll('.edit-button').forEach(b => b.addEventListener('click', e => navigate(`/edit/${e.target.dataset.id}`)));
            document.getElementById('createQuizLink').addEventListener('click', e => { e.preventDefault(); navigate('/createquiz'); });
            document.getElementById('backToAdmin').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        async function renderEditQuestion(questionId) {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let question = {}; let error = '';
            try {
                const response = await fetch(`/api/quiz/questions/${questionId}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if(response.ok) { question = await response.json(); } else { throw new Error('Failed to fetch'); }
            } catch (e) { error = 'å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const updatedQuestion = { genre: event.target.genre.value, title: event.target.title.value, choices: event.target.choices.value, answer: event.target.answer.value, explanation: event.target.explanation.value };
                try {
                    const res = await fetch(`/api/quiz/questions/${questionId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(updatedQuestion) });
                    if (res.ok) { alert('æ›´æ–°ã—ã¾ã—ãŸ'); navigate('/q_list'); } else { throw new Error('Update failed'); }
                } catch (e) { alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
            };
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œç·¨é›†</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="editQuestionForm">
                        <div class="form-group"><label>å•é¡Œç•ªå·ï¼š</label><input type="text" class="form-control" name="Q_no" value="${question.Q_no || ''}" readonly></div>
                        <div class="form-group"><label>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label><input type="text" class="form-control" name="genre" value="${question.genre || ''}" required></div>
                        <div class="form-group"><label>å•é¡Œæ–‡ï¼š</label><textarea class="form-control" name="title" rows="3" required>${question.title || ''}</textarea></div>
                        <div class="form-group"><label>é¸æŠè‚¢ (ä¾‹: é¸1:é¸2):</label><input type="text" class="form-control" name="choices" value="${question.choices || ''}" required></div>
                        <div class="form-group"><label>æ­£è§£ (ä¾‹: é¸1):</label><input type="text" class="form-control" name="answer" value="${question.answer || ''}" required></div>
                        <div class="form-group"><label>è§£èª¬ï¼š</label><textarea class="form-control" name="explanation" rows="5">${question.explanation || ''}</textarea></div>
                        <button type="submit" class="btn btn-primary mt-3 btn-block">ä¿å­˜</button>
                    </form>
                    <div class="mt-3 text-center"><a href="/q_list" id="backToListLink" class="btn btn-secondary">æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.getElementById('editQuestionForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', (e) => { e.preventDefault(); navigate('/q_list'); });
        }

        function renderCreateQuiz() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let error = '';
            const handleSubmit = async (event) => {
                event.preventDefault();
                const newQuestion = { genre: event.target.genre.value, title: event.target.title.value, choices: event.target.choices.value, answer: event.target.answer.value, explanation: event.target.explanation.value };
                if (!newQuestion.genre || !newQuestion.title || !newQuestion.choices || !newQuestion.answer) {
                    renderCreateQuiz('ã‚¸ãƒ£ãƒ³ãƒ«ã€å•é¡Œæ–‡ã€é¸æŠè‚¢ã€æ­£è§£ã¯å¿…é ˆã§ã™ã€‚');
                    return;
                }
                try {
                    const response = await fetch('/api/quiz/questions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(newQuestion) });
                    if (response.ok) { alert('å•é¡ŒãŒä½œæˆã•ã‚Œã¾ã—ãŸ'); navigate('/q_list'); } else { const data = await response.json(); renderCreateQuiz(data.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
                } catch (err) { renderCreateQuiz('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'); }
            };
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">å•é¡Œä½œæˆ</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="createQuizForm">
                        <div class="form-group"><label>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label><input type="text" class="form-control" name="genre" required></div>
                        <div class="form-group"><label>å•é¡Œæ–‡ï¼š</label><textarea class="form-control" name="title" rows="3" required></textarea></div>
                        <div class="form-group"><label>é¸æŠè‚¢ (ä¾‹: é¸1:é¸2):</label><input type="text" class="form-control" name="choices" required></div>
                        <div class="form-group"><label>æ­£è§£ (ä¾‹: é¸1):</label><input type="text" class="form-control" name="answer" required></div>
                        <div class="form-group"><label>è§£èª¬ï¼š</label><textarea class="form-control" name="explanation" rows="5"></textarea></div>
                        <button type="submit" class="btn btn-primary btn-block">ä½œæˆ</button>
                    </form>
                    <div class="mt-3 text-center"><a href="/q_list" id="backToListLink" class="btn btn-secondary">æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.getElementById('createQuizForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', e => { e.preventDefault(); navigate('/q_list'); });
        }

        function renderFirstQuestion(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { category, nanko } = state || {};
            if (!category || !nanko) { alert('ã‚¯ã‚¤ã‚ºè¨­å®šãŒä¸æ­£ã§ã™ã€‚'); navigate('/genre'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ã“ã‚Œã‹ã‚‰å•é¡Œã‚’å§‹ã‚ã¾ã™</h1>
                    <h2 class="text-center">ã‚¸ãƒ£ãƒ³ãƒ«: <span class="badge badge-secondary">${category}</span></h2>
                    <p class="text-center lead">${nanko}å•å‡ºé¡Œã•ã‚Œã¾ã™ã€‚</p>
                    <div class="text-center mt-5"><button id="startQuizButton" class="btn btn-success btn-lg">ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹</button></div>
                    <div class="text-center mt-3"><a href="/genre" class="btn btn-link">ã‚¯ã‚¤ã‚ºè¨­å®šã«æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            document.getElementById('startQuizButton').addEventListener('click', () => navigate('/question', { category, nanko }));
            document.querySelector('.btn-link').addEventListener('click', e => { e.preventDefault(); navigate('/genre'); });
        }

        async function renderGenre() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let genres = {}; let error = '';
            try {
                const response = await fetch('/api/quiz/genres', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { genres = await response.json(); } else { throw new Error('Failed to fetch genres'); }
            } catch (e) { error = 'ã‚¸ãƒ£ãƒ³ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ã‚¯ã‚¤ã‚ºè¨­å®š</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    ${Object.keys(genres).length > 0 ? `<form id="genreForm"><h3 class="mb-3">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ:</h3><ul class="list-group mb-4">${Object.entries(genres).map(([g, ids]) => `<li class="list-group-item d-flex justify-content-between align-items-center"><div class="form-check"><input class="form-check-input" type="radio" name="category" id="genre-${g}" value="${g}" data-length="${ids.length}" ${Object.keys(genres)[0] === g ? 'checked' : ''}><label class="form-check-label" for="genre-${g}"><strong>${g}</strong></label></div><span class="badge badge-primary badge-pill">${ids.length}å•</span></li>`).join('')}</ul><div class="form-group"><label for="numQuestionsInput">å‡ºé¡Œæ•° (1 - <span id="maxQuestions">${Object.values(genres)[0].length}</span>):</label><input type="number" class="form-control" id="numQuestionsInput" value="1" min="1" max="${Object.values(genres)[0].length}"></div><button type="submit" class="btn btn-primary btn-block mt-4">ã‚¯ã‚¤ã‚ºè¨­å®šã‚’é€ä¿¡</button></form>` : '<p class="text-center">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}
                    <div class="text-center mt-3"><a href="${Auth.isAdmin() ? '/admin' : '/dashboard'}" class="btn btn-link">æˆ»ã‚‹</a></div>
                </div>`;
            render(html);

            const genreForm = document.getElementById('genreForm');
            if(genreForm) {
                const numQuestionsInput = document.getElementById('numQuestionsInput');
                const maxQuestionsSpan = document.getElementById('maxQuestions');
                document.querySelectorAll('input[name="category"]').forEach(radio => {
                    radio.addEventListener('change', e => {
                        const len = e.target.dataset.length;
                        maxQuestionsSpan.textContent = len;
                        numQuestionsInput.max = len;
                        if (parseInt(numQuestionsInput.value) > len) numQuestionsInput.value = len;
                    });
                });
                genreForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const category = document.querySelector('input[name="category"]:checked').value;
                    const nanko = parseInt(numQuestionsInput.value);
                    if (nanko > 0 && nanko <= parseInt(numQuestionsInput.max)) {
                        navigate('/firstquestion', { category, nanko });
                    } else { alert('å‡ºé¡Œæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); }
                });
            }
            document.querySelector('.btn-link').addEventListener('click', e => { e.preventDefault(); navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); });
        }

        function renderKekka(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { resultData, questionData } = state || {};
            if (!resultData || !questionData) { render('çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const isLastQuestion = currentQuestionIndex >= currentQuestions.length - 1;
            const html = `
                <div class="container">
                    <div class="card-header text-center p-3 mb-3 bg-primary text-white"><h3 class="mb-0">çµæœ</h3></div>
                    <div class="card-body">
                        <div style="color: ${resultData.answer.includes('æ­£è§£') ? 'green' : 'red'}; font-size: 2em; text-align: center;">${resultData.answer.includes('æ­£è§£') ? 'ğŸ‰ æ­£è§£ï¼' : 'æ®‹å¿µï¼ä¸æ­£è§£...'}</div>
                        <p>ã‚ãªãŸã®é¸æŠ: ${resultData.user_choice.join(', ')}</p>
                        <p>æ­£è§£: ${resultData.correct_ans.join(', ')}</p>
                        ${questionData.explanation ? `<h4>è§£èª¬</h4><p>${questionData.explanation}</p>` : ''}
                        <p class="text-muted">çµŒéæ™‚é–“: ${parseFloat(resultData.elapsed_time).toFixed(2)}ç§’</p>
                        <div class="d-flex justify-content-between mt-4">
                            <button id="nextQuestionButton" class="btn btn-primary btn-lg">${isLastQuestion ? 'ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã™ã‚‹' : 'æ¬¡ã®å•é¡Œã¸'}</button>
                            <a href="${Auth.isAdmin() ? '/view' : '/my_results'}" class="btn btn-secondary btn-lg" id="viewResultsLink">çµæœä¸€è¦§ã¸</a>
                        </div>
                    </div>
                </div>`;
            render(html);
            document.getElementById('nextQuestionButton').addEventListener('click', () => {
                if (isLastQuestion) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); } 
                else { currentQuestionIndex++; navigate('/question'); }
            });
            document.getElementById('viewResultsLink').addEventListener('click', e => { e.preventDefault(); navigate(Auth.isAdmin() ? '/view' : '/my_results'); });
        }

        async function renderView() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let results = {}; let error = '';
            try {
                const response = await fetch('/api/admin/results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { results = await response.json(); } else { throw new Error('Failed to fetch results'); }
            } catch (e) { error = 'çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
            const chartDataByUser = {};
            if (Object.keys(results).length > 0) {
                // Chart data processing...
            }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">æ­£ç­”ç‡ã®çµæœ</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <div class="mt-4">
                        <h2 class="text-center mb-3">åå‰ã¨ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ­£ç­”ç‡</h2>
                        ${Object.keys(results).length > 0 ? `<table class="table table-bordered"><thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><th>æ­£ç­”ç‡</th><th>æ­£è§£/ç·æ•°</th><th>ãƒŸã‚¹ã—ãŸå•é¡Œ</th></tr></thead><tbody>${Object.entries(results).map(([name, genres]) => Object.entries(genres).map(([g, data]) => `<tr><td>${name}</td><td>${g}</td><td>${((data.correct / data.total) * 100 || 0).toFixed(1)}%</td><td>${data.correct}/${data.total}</td><td>${data.error.map(id => `<a href="/admin/retry/${id}" data-id="${id}" data-genre="${g}" class="retry-link">${id}</a>`).join(', ') || 'ãªã—'}</td></tr>`).join('')).join('')}</tbody></table>` : '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
                    </div>
                    <div id="charts-container"></div>
                    <div class="text-center mt-4"><a href="/admin" class="btn btn-secondary btn-lg">æˆ»ã‚‹</a></div>
                </div>`;
            render(html);
            // Chart rendering logic...
            document.querySelectorAll('.retry-link').forEach(link => {
                link.addEventListener('click', e => { e.preventDefault(); handleRetryQuestion(e.target.dataset.id, e.target.dataset.genre); });
            });
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        let currentQuestions = []; let currentQuestionIndex = 0; let selectedChoices = []; let quizStartTime = null; let currentQuizConfig = { category: '', nanko: 0 };
        async function renderQuestion(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { category, nanko, resetQuiz, retriedQuestionData } = state || currentQuizConfig;
            let error = '';
            if (resetQuiz || currentQuestions.length === 0) {
                try {
                    currentQuestions = retriedQuestionData ? [retriedQuestionData] : await (async () => {
                        const res = await fetch(`/api/quiz/get_random_questions?genre=${category}&count=${nanko}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                        if(!res.ok) throw new Error();
                        return await res.json();
                    })();
                    if (currentQuestions.length === 0) throw new Error('No questions found');
                    currentQuestionIndex = 0;
                    currentQuizConfig = { category, nanko };
                } catch (e) { error = 'å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'; render(`<div class="error-message">${error}</div>`); return; }
            }
            if (currentQuestionIndex >= currentQuestions.length) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
            
            const q = currentQuestions[currentQuestionIndex];
            selectedChoices = [];
            quizStartTime = new Date();
            const choices = (q.choices || "").split(':').filter(c => c);

            const handleSubmit = async () => {
                if (selectedChoices.length === 0) { alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
                const payload = { user_choice: selectedChoices, correct_ans: (q.correct_ans || q.answer).split(':'), start_datetime: quizStartTime.toISOString(), username: Auth.username, genre: q.genre, qmap: q.Q_no, question_id: q.rowid || q.question_id, kaisetsu: q.explanation || q.kaisetsu };
                try {
                    const res = await fetch('/api/quiz/check_answer', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error();
                    const resultData = await res.json();
                    navigate('/kekka', { resultData, questionData: q });
                } catch (e) { alert('è§£ç­”ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            };
            
            const html = `
                <div class="container"><h1 class="text-center mb-4">å•é¡Œ ${currentQuestionIndex + 1}/${currentQuestions.length}</h1><div class="card mt-4"><div class="card-header bg-info text-white">ã‚¸ãƒ£ãƒ³ãƒ«: ${q.genre}</div><div class="card-body"><h4 class="card-title mb-4">${q.title || q.question}</h4><div class="form-group">${choices.map((c, i) => `<div class="form-check"><input type="checkbox" class="form-check-input" id="c${i}" value="${c}"><label class="form-check-label" for="c${i}">${c}</label></div>`).join('')}</div><button id="submitAnswerBtn" class="btn btn-primary mt-4 btn-block">è§£ç­”ã™ã‚‹</button></div></div></div>`;
            render(html);
            document.querySelectorAll('.form-check-input').forEach(box => box.addEventListener('change', e => {
                if(e.target.checked) selectedChoices.push(e.target.value);
                else selectedChoices = selectedChoices.filter(c => c !== e.target.value);
            }));
            document.getElementById('submitAnswerBtn').addEventListener('click', handleSubmit);
        }

        async function handleRetryQuestion(questionId, genre) {
            if (!Auth.isAdmin()) { return; }
            try {
                const response = await fetch(`/api/admin/retry/${questionId}?genre=${genre}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error();
                const data = await response.json();
                navigate('/question', { category: genre, nanko: 1, resetQuiz: true, retriedQuestionData: data });
            } catch (e) { alert('å•é¡Œã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        }

        // --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---
        function handleRouting() {
            const path = window.location.pathname;
            const state = history.state;
            if (!Auth.isAuthenticated() && path !== '/login' && path !== '/signup') { navigate('/login'); return; }
            switch (true) {
                case path === '/login' || path === '/':
                    if (Auth.isAuthenticated()) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
                    renderLogin(state ? state.error : '');
                    break;
                case path === '/signup':
                    if (Auth.isAuthenticated()) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
                    renderSignup(state ? state.error : '');
                    break;
                case path === '/dashboard': renderDashboard(); break;
                case path === '/my_results': renderMyResults(); break;
                case path === '/users': renderUserList(); break;
                case path === '/admin': renderAdmin(); break;
                case path === '/q_list': renderQuestionList(); break;
                case path === '/createquiz': renderCreateQuiz(); break;
                case path === '/genre': renderGenre(); break;
                case path === '/firstquestion': renderFirstQuestion(state); break;
                case path === '/question': renderQuestion(state); break;
                case path === '/kekka': renderKekka(state); break;
                case path === '/view': renderView(); break;
                case path.startsWith('/edit/'):
                    renderEditQuestion(path.split('/')[2]);
                    break;
                case path.startsWith('/admin/retry/'):
                    renderQuestion(state);
                    break;
                default:
                    render(`<div>404 Not Found</div>`);
                    break;
            }
        }
        
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);
    </script>
</body>
</html>