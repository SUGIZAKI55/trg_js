<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .error-message { color: red; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .success-message { color: green; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .signup-link, .login-link { text-align: center; margin-top: 15px; }
        .signup-link a, .login-link a { color: #4CAF50; }
        .tab { text-align: center; margin-top: 50px; }
        .tab button { margin: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #e9ecef; font-weight: bold; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e6e6e6; }
        .chart-container { width: 90%; margin: 40px auto; background-color: #ffffff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .form-group { margin-bottom: 1.5rem; }
        .dashboard-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .dashboard-button { padding: 2rem; font-size: 1.2rem; }
    </style>
</head>

<body>
    <div id="root"></div>
    <script>
        // --- ユーティリティ関数 ---
        function render(componentHtml) {
            document.getElementById('root').innerHTML = componentHtml;
        }

        function navigate(path, state = {}) {
            if (window.location.pathname !== path || JSON.stringify(history.state) !== JSON.stringify(state)) {
                history.pushState(state, '', path);
                handleRouting();
            }
        }

        // --- 認証状態管理 ---
        const Auth = {
            token: localStorage.getItem('token') || null,
            username: localStorage.getItem('username') || null,
            role: localStorage.getItem('role') || null,
            setToken(newToken) { this.token = newToken; if (newToken) localStorage.setItem('token', newToken); else localStorage.removeItem('token'); },
            setUsername(newUsername) { this.username = newUsername; if (newUsername) localStorage.setItem('username', newUsername); else localStorage.removeItem('username'); },
            setRole(newRole) { this.role = newRole; if (newRole) localStorage.setItem('role', newRole); else localStorage.removeItem('role'); },
            login(newToken, newUsername, newRole) {
                this.setToken(newToken);
                this.setUsername(newUsername);
                this.setRole(newRole);
                if (newRole === 'admin') {
                    navigate('/admin');
                } else {
                    navigate('/dashboard'); 
                }
            },
            logout() {
                this.setToken(null);
                this.setUsername(null);
                this.setRole(null);
                navigate('/login');
            },
            isAuthenticated() { return this.token !== null; },
            isAdmin() { return this.isAuthenticated() && this.role === 'admin'; }
        };

        // --- 各コンポーネント ---

        function renderLogin(initialError = '') {
            let errorMessage = initialError;
            let successMessage = '';
            if (history.state && history.state.signupSuccess) {
                successMessage = 'サインアップに成功しました。ログインしてください。';
                history.replaceState({}, '', '/login');
            }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        Auth.login(data.token, data.username, data.role);
                    } else {
                        renderLogin(data.message || 'Login failed');
                    }
                } catch (err) {
                    renderLogin('ネットワークエラー: ' + err.message);
                }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">ログイン</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    ${successMessage ? `<div class="success-message">${successMessage}</div>` : ''}
                    <form id="loginForm">
                        <div class="form-group"><label for="username">ユーザー名:</label><input type="text" class="form-control" id="username" name="username" required></div>
                        <div class="form-group"><label for="password">パスワード:</label><input type="password" class="form-control" id="password" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">ログイン</button>
                    </form>
                    <div class="signup-link"><p>アカウントをお持ちではありませんか？ <a href="/signup">新規登録</a></p></div>
                </div>`;
            render(html);
            document.getElementById('loginForm').addEventListener('submit', handleSubmit);
            document.querySelector('.signup-link a').addEventListener('click', (e) => { e.preventDefault(); navigate('/signup'); });
        }

        function renderSignup(initialError = '') {
            let errorMessage = initialError;
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                const confirmPassword = event.target.confirmPassword.value;
                if (password !== confirmPassword) {
                    renderSignup('パスワードが一致しません。'); 
                    return;
                }
                if (password.length < 6) {
                    renderSignup('パスワードは6文字以上で入力してください。');
                    return;
                }
                try {
                    const response = await fetch('/api/auth/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (response.ok) {
                        navigate('/login', { signupSuccess: true });
                    } else {
                        renderSignup(data.message || '新規登録に失敗しました');
                    }
                } catch (err) {
                    renderSignup('ネットワークエラー: ' + err.message);
                }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">新規登録</h2>
                    ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
                    <form id="signupForm">
                        <div class="form-group"><label for="username">ユーザー名:</label><input type="text" class="form-control" id="username" name="username" required></div>
                        <div class="form-group"><label for="password">パスワード:</label><input type="password" class="form-control" id="password" name="password" required minlength="6"><small class="form-text text-muted">6文字以上で入力してください。</small></div>
                        <div class="form-group"><label for="confirmPassword">パスワード（確認）:</label><input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required minlength="6"></div>
                        <button type="submit" class="btn btn-primary btn-block">新規登録</button>
                    </form>
                    <div class="login-link"><p>すでにアカウントをお持ちですか？ <a href="/login">ログイン</a></p></div>
                </div>`;
            render(html);
            document.getElementById('signupForm').addEventListener('submit', handleSubmit);
            document.querySelector('.login-link a').addEventListener('click', (e) => { e.preventDefault(); navigate('/login'); });
        }

        function renderDashboard() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center">ようこそ、${Auth.username}さん</h1>
                    <p class="text-center text-muted">操作を選択してください。</p>
                    <div class="dashboard-button-grid">
                        <button id="startQuizBtn" class="btn btn-primary dashboard-button">テストを実施</button>
                        <button id="myResultsBtn" class="btn btn-info dashboard-button">自分の成績を見る</button>
                        <button id="logoutBtn" class="btn btn-danger dashboard-button">ログアウト</button>
                    </div>
                </div>`;
            render(html);
            document.getElementById('startQuizBtn').addEventListener('click', () => navigate('/genre'));
            document.getElementById('myResultsBtn').addEventListener('click', () => navigate('/my_results'));
            document.getElementById('logoutBtn').addEventListener('click', () => Auth.logout());
        }

        async function renderMyResults() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let myResults = {};
            let error = '';
            try {
                const response = await fetch('/api/user/my_results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error('成績の取得に失敗しました。');
                myResults = await response.json();
            } catch (err) {
                error = err.message;
            }
            const chartData = { labels: [], accuracies: [], backgroundColors: [], borderColors: [] };
            if (Object.keys(myResults).length > 0) {
                for (const genre in myResults) {
                    const data = myResults[genre];
                    if (data.total > 0) {
                        const accuracy = parseFloat(((data.correct / data.total) * 100).toFixed(2));
                        chartData.labels.push(genre);
                        chartData.accuracies.push(accuracy);
                        if (accuracy >= 80) { chartData.backgroundColors.push('rgba(75, 192, 192, 0.6)'); chartData.borderColors.push('rgba(75, 192, 192, 1)'); }
                        else if (accuracy >= 50) { chartData.backgroundColors.push('rgba(255, 206, 86, 0.6)'); chartData.borderColors.push('rgba(255, 206, 86, 1)'); }
                        else { chartData.backgroundColors.push('rgba(255, 99, 132, 0.6)'); chartData.borderColors.push('rgba(255, 99, 132, 1)'); }
                    }
                }
            } else { error = "まだ解答履歴がありません。"; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">${Auth.username}さんの成績</h1>
                    ${error ? `<div class="alert alert-info text-center">${error}</div>` : ''}
                    ${chartData.labels.length > 0 ? `<div class="chart-container"><h3 class="text-center mb-3">ジャンル別正答率</h3><canvas id="myAccuracyChart"></canvas></div>` : ''}
                    <div class="text-center mt-4"><a href="/dashboard" id="backToDashboard" class="btn btn-secondary btn-lg">マイページに戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('backToDashboard').addEventListener('click', e => { e.preventDefault(); navigate('/dashboard'); });
            if (chartData.labels.length > 0) {
                const ctx = document.getElementById('myAccuracyChart');
                if (ctx) {
                    new Chart(ctx, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label: '正答率 (%)', data: chartData.accuracies, backgroundColor: chartData.backgroundColors, borderColor: chartData.borderColors, borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } } } });
                }
            }
        }
        
        function renderAdmin() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center">${Auth.username} の管理者画面</h1>
                    <div class="tab">
                        <button id="testButton" class="btn btn-info">テストを実施</button>
                        <button id="qListButton" class="btn btn-info">テスト一覧・編集</button>
                        <button id="createQuizButton" class="btn btn-info">テスト作成</button>
                        <button id="viewResultsButton" class="btn btn-info">テスト結果</button>
                        <button id="userListButton" class="btn btn-secondary">ユーザー一覧</button>
                        <button id="logoutButton" class="btn btn-danger">ログアウト</button>
                    </div>
                </div>`;
            render(html);
            document.getElementById('testButton').addEventListener('click', () => navigate('/genre'));
            document.getElementById('qListButton').addEventListener('click', () => navigate('/q_list'));
            document.getElementById('createQuizButton').addEventListener('click', () => navigate('/createquiz'));
            document.getElementById('viewResultsButton').addEventListener('click', () => navigate('/view'));
            document.getElementById('userListButton').addEventListener('click', () => navigate('/users'));
            document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
        }

        async function renderUserList() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let users = [];
            let error = '';
            try {
                const response = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error('ユーザーリストの取得に失敗しました。');
                users = await response.json();
            } catch (err) { error = err.message; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ユーザー一覧</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    ${users.length > 0 ? `
                        <table class="table table-striped table-bordered">
                            <thead><tr><th>ID</th><th>ユーザー名</th><th>役割</th><th>登録日時</th></tr></thead>
                            <tbody>${users.map(user => `<tr><td>${user.id}</td><td>${user.username}</td><td><span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">${user.role}</span></td><td>${new Date(user.created_at).toLocaleString('ja-JP')}</td></tr>`).join('')}</tbody>
                        </table>` : '<p class="text-center">ユーザーがいません。</p>'}
                     <div class="text-center mt-4"><a href="/admin" id="backToAdmin" class="btn btn-secondary">管理者画面に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('backToAdmin').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }
        
        async function renderQuestionList() {
             if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let questions = []; let error = '';
            try {
                const response = await fetch('/api/quiz/questions', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { questions = await response.json(); } else { throw new Error('Failed to fetch'); }
            } catch (err) { error = '問題の取得に失敗しました。'; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">問題一覧</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <ul class="list-group">
                        ${questions.length > 0 ? questions.map(q => `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${q.Q_no || ''} | ${q.genre} | ${q.title.substring(0, 50)}...</span><button data-id="${q.rowid}" class="edit-button btn btn-sm btn-info ml-2">編集</button></li>`).join('') : '<li class="list-group-item">問題がありません。</li>'}
                    </ul>
                    <div class="text-center mt-4"><a href="/createquiz" id="createQuizLink" class="btn btn-primary">問題作成</a> <a href="/admin" id="backToAdmin" class="btn btn-secondary">戻る</a></div>
                </div>`;
            render(html);
            document.querySelectorAll('.edit-button').forEach(b => b.addEventListener('click', e => navigate(`/edit/${e.target.dataset.id}`)));
            document.getElementById('createQuizLink').addEventListener('click', e => { e.preventDefault(); navigate('/createquiz'); });
            document.getElementById('backToAdmin').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        async function renderEditQuestion(questionId) {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let question = {}; let error = '';
            try {
                const response = await fetch(`/api/quiz/questions/${questionId}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if(response.ok) { question = await response.json(); } else { throw new Error('Failed to fetch'); }
            } catch (e) { error = '問題の取得に失敗しました。'; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const updatedQuestion = { genre: event.target.genre.value, title: event.target.title.value, choices: event.target.choices.value, answer: event.target.answer.value, explanation: event.target.explanation.value };
                try {
                    const res = await fetch(`/api/quiz/questions/${questionId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(updatedQuestion) });
                    if (res.ok) { alert('更新しました'); navigate('/q_list'); } else { throw new Error('Update failed'); }
                } catch (e) { alert('更新に失敗しました。'); }
            };
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">問題編集</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="editQuestionForm">
                        <div class="form-group"><label>問題番号：</label><input type="text" class="form-control" name="Q_no" value="${question.Q_no || ''}" readonly></div>
                        <div class="form-group"><label>ジャンル：</label><input type="text" class="form-control" name="genre" value="${question.genre || ''}" required></div>
                        <div class="form-group"><label>問題文：</label><textarea class="form-control" name="title" rows="3" required>${question.title || ''}</textarea></div>
                        <div class="form-group"><label>選択肢 (例: 選1:選2):</label><input type="text" class="form-control" name="choices" value="${question.choices || ''}" required></div>
                        <div class="form-group"><label>正解 (例: 選1):</label><input type="text" class="form-control" name="answer" value="${question.answer || ''}" required></div>
                        <div class="form-group"><label>解説：</label><textarea class="form-control" name="explanation" rows="5">${question.explanation || ''}</textarea></div>
                        <button type="submit" class="btn btn-primary mt-3 btn-block">保存</button>
                    </form>
                    <div class="mt-3 text-center"><a href="/q_list" id="backToListLink" class="btn btn-secondary">戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('editQuestionForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', (e) => { e.preventDefault(); navigate('/q_list'); });
        }

        function renderCreateQuiz() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let error = '';
            const handleSubmit = async (event) => {
                event.preventDefault();
                const newQuestion = { genre: event.target.genre.value, title: event.target.title.value, choices: event.target.choices.value, answer: event.target.answer.value, explanation: event.target.explanation.value };
                if (!newQuestion.genre || !newQuestion.title || !newQuestion.choices || !newQuestion.answer) {
                    renderCreateQuiz('ジャンル、問題文、選択肢、正解は必須です。');
                    return;
                }
                try {
                    const response = await fetch('/api/quiz/questions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(newQuestion) });
                    if (response.ok) { alert('問題が作成されました'); navigate('/q_list'); } else { const data = await response.json(); renderCreateQuiz(data.message || '作成に失敗しました'); }
                } catch (err) { renderCreateQuiz('ネットワークエラー'); }
            };
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">問題作成</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <form id="createQuizForm">
                        <div class="form-group"><label>ジャンル：</label><input type="text" class="form-control" name="genre" required></div>
                        <div class="form-group"><label>問題文：</label><textarea class="form-control" name="title" rows="3" required></textarea></div>
                        <div class="form-group"><label>選択肢 (例: 選1:選2):</label><input type="text" class="form-control" name="choices" required></div>
                        <div class="form-group"><label>正解 (例: 選1):</label><input type="text" class="form-control" name="answer" required></div>
                        <div class="form-group"><label>解説：</label><textarea class="form-control" name="explanation" rows="5"></textarea></div>
                        <button type="submit" class="btn btn-primary btn-block">作成</button>
                    </form>
                    <div class="mt-3 text-center"><a href="/q_list" id="backToListLink" class="btn btn-secondary">戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('createQuizForm').addEventListener('submit', handleSubmit);
            document.getElementById('backToListLink').addEventListener('click', e => { e.preventDefault(); navigate('/q_list'); });
        }

        function renderFirstQuestion(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { category, nanko } = state || {};
            if (!category || !nanko) { alert('クイズ設定が不正です。'); navigate('/genre'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">これから問題を始めます</h1>
                    <h2 class="text-center">ジャンル: <span class="badge badge-secondary">${category}</span></h2>
                    <p class="text-center lead">${nanko}問出題されます。</p>
                    <div class="text-center mt-5"><button id="startQuizButton" class="btn btn-success btn-lg">クイズを開始する</button></div>
                    <div class="text-center mt-3"><a href="/genre" class="btn btn-link">クイズ設定に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('startQuizButton').addEventListener('click', () => navigate('/question', { category, nanko }));
            document.querySelector('.btn-link').addEventListener('click', e => { e.preventDefault(); navigate('/genre'); });
        }

        async function renderGenre() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let genres = {}; let error = '';
            try {
                const response = await fetch('/api/quiz/genres', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { genres = await response.json(); } else { throw new Error('Failed to fetch genres'); }
            } catch (e) { error = 'ジャンルの取得に失敗しました。'; }
            
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">クイズ設定</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    ${Object.keys(genres).length > 0 ? `<form id="genreForm"><h3 class="mb-3">ジャンル選択:</h3><ul class="list-group mb-4">${Object.entries(genres).map(([g, ids]) => `<li class="list-group-item d-flex justify-content-between align-items-center"><div class="form-check"><input class="form-check-input" type="radio" name="category" id="genre-${g}" value="${g}" data-length="${ids.length}" ${Object.keys(genres)[0] === g ? 'checked' : ''}><label class="form-check-label" for="genre-${g}"><strong>${g}</strong></label></div><span class="badge badge-primary badge-pill">${ids.length}問</span></li>`).join('')}</ul><div class="form-group"><label for="numQuestionsInput">出題数 (1 - <span id="maxQuestions">${Object.values(genres)[0].length}</span>):</label><input type="number" class="form-control" id="numQuestionsInput" value="1" min="1" max="${Object.values(genres)[0].length}"></div><button type="submit" class="btn btn-primary btn-block mt-4">クイズ設定を送信</button></form>` : '<p class="text-center">問題がありません。</p>'}
                    <div class="text-center mt-3"><a href="${Auth.isAdmin() ? '/admin' : '/dashboard'}" class="btn btn-link">戻る</a></div>
                </div>`;
            render(html);

            const genreForm = document.getElementById('genreForm');
            if(genreForm) {
                const numQuestionsInput = document.getElementById('numQuestionsInput');
                const maxQuestionsSpan = document.getElementById('maxQuestions');
                document.querySelectorAll('input[name="category"]').forEach(radio => {
                    radio.addEventListener('change', e => {
                        const len = e.target.dataset.length;
                        maxQuestionsSpan.textContent = len;
                        numQuestionsInput.max = len;
                        if (parseInt(numQuestionsInput.value) > len) numQuestionsInput.value = len;
                    });
                });
                genreForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const category = document.querySelector('input[name="category"]:checked').value;
                    const nanko = parseInt(numQuestionsInput.value);
                    if (nanko > 0 && nanko <= parseInt(numQuestionsInput.max)) {
                        navigate('/firstquestion', { category, nanko });
                    } else { alert('出題数を正しく入力してください。'); }
                });
            }
            document.querySelector('.btn-link').addEventListener('click', e => { e.preventDefault(); navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); });
        }

        function renderKekka(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { resultData, questionData } = state || {};
            if (!resultData || !questionData) { render('結果データがありません'); return; }
            const isLastQuestion = currentQuestionIndex >= currentQuestions.length - 1;
            const html = `
                <div class="container">
                    <div class="card-header text-center p-3 mb-3 bg-primary text-white"><h3 class="mb-0">結果</h3></div>
                    <div class="card-body">
                        <div style="color: ${resultData.answer.includes('正解') ? 'green' : 'red'}; font-size: 2em; text-align: center;">${resultData.answer.includes('正解') ? '🎉 正解！' : '残念！不正解...'}</div>
                        <p>あなたの選択: ${resultData.user_choice.join(', ')}</p>
                        <p>正解: ${resultData.correct_ans.join(', ')}</p>
                        ${questionData.explanation ? `<h4>解説</h4><p>${questionData.explanation}</p>` : ''}
                        <p class="text-muted">経過時間: ${parseFloat(resultData.elapsed_time).toFixed(2)}秒</p>
                        <div class="d-flex justify-content-between mt-4">
                            <button id="nextQuestionButton" class="btn btn-primary btn-lg">${isLastQuestion ? 'クイズを終了する' : '次の問題へ'}</button>
                            <a href="${Auth.isAdmin() ? '/view' : '/my_results'}" class="btn btn-secondary btn-lg" id="viewResultsLink">結果一覧へ</a>
                        </div>
                    </div>
                </div>`;
            render(html);
            document.getElementById('nextQuestionButton').addEventListener('click', () => {
                if (isLastQuestion) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); } 
                else { currentQuestionIndex++; navigate('/question'); }
            });
            document.getElementById('viewResultsLink').addEventListener('click', e => { e.preventDefault(); navigate(Auth.isAdmin() ? '/view' : '/my_results'); });
        }

        async function renderView() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let results = {}; let error = '';
            try {
                const response = await fetch('/api/admin/results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { results = await response.json(); } else { throw new Error('Failed to fetch results'); }
            } catch (e) { error = '結果の取得に失敗しました。'; }
            const chartDataByUser = {};
            if (Object.keys(results).length > 0) {
                // Chart data processing...
            }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">正答率の結果</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <div class="mt-4">
                        <h2 class="text-center mb-3">名前とジャンル別正答率</h2>
                        ${Object.keys(results).length > 0 ? `<table class="table table-bordered"><thead><tr><th>ユーザー名</th><th>ジャンル</th><th>正答率</th><th>正解/総数</th><th>ミスした問題</th></tr></thead><tbody>${Object.entries(results).map(([name, genres]) => Object.entries(genres).map(([g, data]) => `<tr><td>${name}</td><td>${g}</td><td>${((data.correct / data.total) * 100 || 0).toFixed(1)}%</td><td>${data.correct}/${data.total}</td><td>${data.error.map(id => `<a href="/admin/retry/${id}" data-id="${id}" data-genre="${g}" class="retry-link">${id}</a>`).join(', ') || 'なし'}</td></tr>`).join('')).join('')}</tbody></table>` : '<p>データがありません</p>'}
                    </div>
                    <div id="charts-container"></div>
                    <div class="text-center mt-4"><a href="/admin" class="btn btn-secondary btn-lg">戻る</a></div>
                </div>`;
            render(html);
            // Chart rendering logic...
            document.querySelectorAll('.retry-link').forEach(link => {
                link.addEventListener('click', e => { e.preventDefault(); handleRetryQuestion(e.target.dataset.id, e.target.dataset.genre); });
            });
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        let currentQuestions = []; let currentQuestionIndex = 0; let selectedChoices = []; let quizStartTime = null; let currentQuizConfig = { category: '', nanko: 0 };
        async function renderQuestion(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { category, nanko, resetQuiz, retriedQuestionData } = state || currentQuizConfig;
            let error = '';
            if (resetQuiz || currentQuestions.length === 0) {
                try {
                    currentQuestions = retriedQuestionData ? [retriedQuestionData] : await (async () => {
                        const res = await fetch(`/api/quiz/get_random_questions?genre=${category}&count=${nanko}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                        if(!res.ok) throw new Error();
                        return await res.json();
                    })();
                    if (currentQuestions.length === 0) throw new Error('No questions found');
                    currentQuestionIndex = 0;
                    currentQuizConfig = { category, nanko };
                } catch (e) { error = '問題の取得に失敗しました'; render(`<div class="error-message">${error}</div>`); return; }
            }
            if (currentQuestionIndex >= currentQuestions.length) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
            
            const q = currentQuestions[currentQuestionIndex];
            selectedChoices = [];
            quizStartTime = new Date();
            const choices = (q.choices || "").split(':').filter(c => c);

            const handleSubmit = async () => {
                if (selectedChoices.length === 0) { alert('選択肢を選んでください'); return; }
                const payload = { user_choice: selectedChoices, correct_ans: (q.correct_ans || q.answer).split(':'), start_datetime: quizStartTime.toISOString(), username: Auth.username, genre: q.genre, qmap: q.Q_no, question_id: q.rowid || q.question_id, kaisetsu: q.explanation || q.kaisetsu };
                try {
                    const res = await fetch('/api/quiz/check_answer', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error();
                    const resultData = await res.json();
                    navigate('/kekka', { resultData, questionData: q });
                } catch (e) { alert('解答の送信に失敗しました'); }
            };
            
            const html = `
                <div class="container"><h1 class="text-center mb-4">問題 ${currentQuestionIndex + 1}/${currentQuestions.length}</h1><div class="card mt-4"><div class="card-header bg-info text-white">ジャンル: ${q.genre}</div><div class="card-body"><h4 class="card-title mb-4">${q.title || q.question}</h4><div class="form-group">${choices.map((c, i) => `<div class="form-check"><input type="checkbox" class="form-check-input" id="c${i}" value="${c}"><label class="form-check-label" for="c${i}">${c}</label></div>`).join('')}</div><button id="submitAnswerBtn" class="btn btn-primary mt-4 btn-block">解答する</button></div></div></div>`;
            render(html);
            document.querySelectorAll('.form-check-input').forEach(box => box.addEventListener('change', e => {
                if(e.target.checked) selectedChoices.push(e.target.value);
                else selectedChoices = selectedChoices.filter(c => c !== e.target.value);
            }));
            document.getElementById('submitAnswerBtn').addEventListener('click', handleSubmit);
        }

        async function handleRetryQuestion(questionId, genre) {
            if (!Auth.isAdmin()) { return; }
            try {
                const response = await fetch(`/api/admin/retry/${questionId}?genre=${genre}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error();
                const data = await response.json();
                navigate('/question', { category: genre, nanko: 1, resetQuiz: true, retriedQuestionData: data });
            } catch (e) { alert('問題の再取得に失敗しました'); }
        }

        // --- ルーティングロジック ---
        function handleRouting() {
            const path = window.location.pathname;
            const state = history.state;
            if (!Auth.isAuthenticated() && path !== '/login' && path !== '/signup') { navigate('/login'); return; }
            switch (true) {
                case path === '/login' || path === '/':
                    if (Auth.isAuthenticated()) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
                    renderLogin(state ? state.error : '');
                    break;
                case path === '/signup':
                    if (Auth.isAuthenticated()) { navigate(Auth.isAdmin() ? '/admin' : '/dashboard'); return; }
                    renderSignup(state ? state.error : '');
                    break;
                case path === '/dashboard': renderDashboard(); break;
                case path === '/my_results': renderMyResults(); break;
                case path === '/users': renderUserList(); break;
                case path === '/admin': renderAdmin(); break;
                case path === '/q_list': renderQuestionList(); break;
                case path === '/createquiz': renderCreateQuiz(); break;
                case path === '/genre': renderGenre(); break;
                case path === '/firstquestion': renderFirstQuestion(state); break;
                case path === '/question': renderQuestion(state); break;
                case path === '/kekka': renderKekka(state); break;
                case path === '/view': renderView(); break;
                case path.startsWith('/edit/'):
                    renderEditQuestion(path.split('/')[2]);
                    break;
                case path.startsWith('/admin/retry/'):
                    renderQuestion(state);
                    break;
                default:
                    render(`<div>404 Not Found</div>`);
                    break;
            }
        }
        
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);
    </script>
</body>
</html>