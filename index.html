<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .error-message { color: red; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .success-message { color: green; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .tab { text-align: center; margin-top: 50px; }
        .tab button { margin: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #e9ecef; font-weight: bold; }
        .dashboard-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .dashboard-button { padding: 2rem; font-size: 1.2rem; }
        /* モーダル用のスタイル */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="modal-container"></div> <script>
        // --- 認証状態管理 ---
        const Auth = {
            token: localStorage.getItem('token') || null, username: localStorage.getItem('username') || null, role: localStorage.getItem('role') || null,
            setToken(t) { this.token = t; if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); },
            setUsername(u) { this.username = u; if (u) localStorage.setItem('username', u); else localStorage.removeItem('username'); },
            setRole(r) { this.role = r; if (r) localStorage.setItem('role', r); else localStorage.removeItem('role'); },
            login(t, u, r) { this.setToken(t); this.setUsername(u); this.setRole(r); navigate(r === 'master' || r === 'admin' ? '/admin' : '/dashboard'); },
            logout() { this.setToken(null); this.setUsername(null); this.setRole(null); navigate('/login'); },
            isAuthenticated() { return this.token !== null; },
            isMaster() { return this.isAuthenticated() && this.role === 'master'; },
            isAdmin() { return this.isAuthenticated() && (this.role === 'admin' || this.role === 'master'); }
        };

        // --- ユーティリティ関数 ---
        function render(c) { document.getElementById('root').innerHTML = c; }
        function navigate(p, s={}) { if (window.location.pathname !== p || JSON.stringify(history.state) !== JSON.stringify(s)) { history.pushState(s, '', p); handleRouting(); } }

        // --- 各コンポーネント ---
        function renderLogin(initialMessage = '', isError = true) {
            let message = initialMessage;
            if (history.state && history.state.signupSuccess) {
                message = '登録に成功しました。ログインしてください。';
                isError = false;
                history.replaceState({}, '', '/login');
            }
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">ログイン</h2>
                    ${messageHtml}
                    <form id="loginForm">
                        <div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div>
                        <div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">ログイン</button>
                    </form>
                    <div class="text-center mt-3"><p>アカウントをお持ちではありませんか？ <a href="/signup">新規登録</a></p></div>
                </div>`;
            render(html);
            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value;
                try {
                    const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    const data = await res.json();
                    if(res.ok) Auth.login(data.token, data.username, data.role);
                    else renderLogin(data.message || 'ログイン失敗', true);
                } catch (err) { renderLogin('ネットワークエラー', true); }
            });
            document.querySelector('a[href="/signup"]').addEventListener('click', e => { e.preventDefault(); navigate('/signup'); });
        }

        function renderSignup(initialMessage = '', isError = true) {
            const messageHtml = initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : '';
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">新規登録</h2>
                    ${messageHtml}
                    <form id="signupForm">
                        <div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div>
                        <div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required minlength="6"></div>
                        <div class="form-group"><label>パスワード(確認):</label><input type="password" class="form-control" name="confirmPassword" required minlength="6"></div>
                        <button type="submit" class="btn btn-primary btn-block">登録</button>
                    </form>
                    <div class="text-center mt-3"><p>既にアカウントをお持ちですか？ <a href="/login">ログイン</a></p></div>
                </div>`;
            render(html);
            document.getElementById('signupForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value, cp = e.target.confirmPassword.value;
                if(p !== cp) { renderSignup('パスワードが一致しません', true); return; }
                try {
                    const res = await fetch('/api/auth/signup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    if(res.ok) {
                        navigate('/login', { signupSuccess: true });
                    } else {
                        const data = await res.json();
                        renderSignup(data.message || '登録に失敗しました', true);
                    }
                } catch (err) {
                    renderSignup('ネットワークエラー', true);
                }
            });
            document.querySelector('a[href="/login"]').addEventListener('click', e => { e.preventDefault(); navigate('/login'); });
        }

        function renderDashboard() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const html = `
                <div class="container">
                    <h1 class="text-center">ようこそ、${Auth.username}さん</h1>
                    <p class="text-center text-muted">操作を選択してください。</p>
                    <div class="dashboard-button-grid">
                        <button id="startQuizBtn" class="btn btn-primary dashboard-button">テストを実施</button>
                        <button id="myResultsBtn" class="btn btn-info dashboard-button">自分の成績を見る</button>
                        <button id="logoutBtn" class="btn btn-danger dashboard-button">ログアウト</button>
                    </div>
                </div>`;
            render(html);
            document.getElementById('startQuizBtn').addEventListener('click', () => navigate('/genre'));
            document.getElementById('myResultsBtn').addEventListener('click', () => navigate('/my_results'));
            document.getElementById('logoutBtn').addEventListener('click', () => Auth.logout());
        }

        async function renderMyResults() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let myResults = []; let error = '';
            try {
                const response = await fetch('/api/user/my_results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { myResults = await response.json(); }
                else { const data = await response.json(); throw new Error(data.message || '成績の取得に失敗しました。'); }
            } catch (err) { error = err.message; }
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">あなたの成績</h1>
                    ${error ? `<div class="alert alert-warning">${error}</div>` : ''}
                    ${myResults.length > 0 ? `<ul class="list-group">${myResults.map(r => `<li class="list-group-item d-flex justify-content-between"><span>${r.title}</span><span class="badge ${r.is_correct ? 'badge-success' : 'badge-danger'}">${r.is_correct ? '正解' : '不正解'}</span></li>`).join('')}</ul>` : '<p class="text-center">まだ解答履歴がありません。</p>'}
                    <div class="text-center mt-4"><a href="/dashboard" class="btn btn-secondary">マイページに戻る</a></div>
                </div>`;
            render(html);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/dashboard'); });
        }

        function renderAdmin() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const masterButtonHtml = Auth.isMaster() ? `<button id="registerCompanyBtn" class="btn btn-success">企業・管理者登録</button>` : '';
            const adminButtonHtml = Auth.isAdmin() ? `<button id="createUserBtn" class="btn btn-primary">受講者登録</button>` : '';
            const html = `
                <div class="container">
                    <h1 class="text-center">${Auth.username} の管理画面</h1><p class="text-center text-muted">役割: ${Auth.role}</p>
                    <div class="tab">
                        ${masterButtonHtml}
                        ${adminButtonHtml}
                        <button id="userListButton" class="btn btn-secondary">ユーザー一覧</button>
                        <button id="qListButton" class="btn btn-info">問題一覧 (開発中)</button>
                        <button id="logoutButton" class="btn btn-danger">ログアウト</button>
                    </div></div>`;
            render(html);
            if (Auth.isMaster()) { document.getElementById('registerCompanyBtn').addEventListener('click', () => navigate('/register_company')); }
            if (Auth.isAdmin()) { document.getElementById('createUserBtn').addEventListener('click', () => navigate('/create_user')); }
            document.getElementById('userListButton').addEventListener('click', () => navigate('/users'));
            document.getElementById('qListButton').addEventListener('click', () => navigate('/q_list'));
            document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
        }

        async function renderUserList() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let users = [], error = '';
            try {
                const response = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!response.ok) throw new Error('ユーザーリストの取得に失敗');
                users = await response.json();
            } catch (err) { error = err.message; }
            const masterAddUserBtn = Auth.isMaster() ? `<a href="/master/create_user" id="masterAddUser" class="btn btn-primary mb-3">受講者を追加</a>` : '';
            const masterAddMasterBtn = Auth.isMaster() ? `<a href="/master/create_master" id="masterAddMaster" class="btn btn-success mb-3 ml-2">マスターを追加</a>` : '';
            const html = `
                <div class="container">
                    <h1 class="text-center mb-4">ユーザー一覧</h1>
                    ${error ? `<div class="error-message">${error}</div>` : ''}
                    <div class="text-right">${masterAddUserBtn}${masterAddMasterBtn}</div>
                    <table class="table table-bordered">
                        <thead><tr><th>ID</th><th>ユーザー名</th><th>役割</th><th>企業名</th><th>登録日時</th><th>操作</th></tr></thead>
                        <tbody>${users.map(u => `
                            <tr>
                                <td>${u.id}</td>
                                <td>${u.username}</td>
                                <td><span class="badge ${u.role === 'master' ? 'badge-danger' : (u.role === 'admin' ? 'badge-success' : 'badge-secondary')}">${u.role}</span></td>
                                <td>${u.company_name || 'N/A'}</td>
                                <td>${new Date(u.created_at).toLocaleString('ja-JP')}</td>
                                <td>${Auth.isMaster() && Auth.username !== u.username ? `<button class="btn btn-warning btn-sm reset-password-btn" data-userid="${u.id}" data-username="${u.username}">リセット</button>` : ''}</td>
                            </tr>`).join('')}</tbody>
                    </table>
                    <div class="text-center mt-4"><a href="/admin" class="btn btn-secondary">管理画面に戻る</a></div>
                </div>`;
            render(html);
            if (Auth.isMaster()) {
                if(document.getElementById('masterAddUser')) document.getElementById('masterAddUser').addEventListener('click', e => { e.preventDefault(); navigate('/master/create_user'); });
                if(document.getElementById('masterAddMaster')) document.getElementById('masterAddMaster').addEventListener('click', e => { e.preventDefault(); navigate('/master/create_master'); });
                document.querySelectorAll('.reset-password-btn').forEach(button => {
                    button.addEventListener('click', e => {
                        renderResetPasswordModal(e.target.dataset.userid, e.target.dataset.username);
                    });
                });
            }
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }
        
        function renderRegisterCompany(initialMessage = '', isError = false) {
            if (!Auth.isMaster()) { navigate('/admin'); return; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const company_name = event.target.company_name.value, admin_username = event.target.admin_username.value, admin_password = event.target.admin_password.value;
                try {
                    const response = await fetch('/api/master/register_company', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ company_name, admin_username, admin_password }) });
                    const data = await response.json();
                    renderRegisterCompany(data.message || '処理完了', !response.ok);
                } catch (err) { renderRegisterCompany('ネットワークエラー', true); }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">企業・管理者登録</h2>
                    ${initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : ''}
                    <form id="registerCompanyForm">
                        <div class="form-group"><label>企業名:</label><input type="text" class="form-control" name="company_name" required></div>
                        <div class="form-group"><label>管理者 ユーザー名:</label><input type="text" class="form-control" name="admin_username" required></div>
                        <div class="form-group"><label>管理者 初期パスワード:</label><input type="password" class="form-control" name="admin_password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">登録</button>
                    </form>
                    <div class="text-center mt-3"><a href="/admin" class="btn btn-secondary">管理画面に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('registerCompanyForm').addEventListener('submit', handleSubmit);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        function renderCreateUser(initialMessage = '', isError = false) {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value, password = event.target.password.value;
                try {
                    const response = await fetch('/api/admin/create_user', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ username, password }) });
                    const data = await response.json();
                    renderCreateUser(data.message || '処理完了', !response.ok);
                } catch (err) { renderCreateUser('ネットワークエラー', true); }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">受講者 登録</h2>
                    ${initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : ''}
                    <form id="createUserForm">
                        <div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div>
                        <div class="form-group"><label>初期パスワード:</label><input type="password" class="form-control" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">登録</button>
                    </form>
                    <div class="text-center mt-3"><a href="/admin" class="btn btn-secondary">管理画面に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('createUserForm').addEventListener('submit', handleSubmit);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }
        
        async function renderMasterCreateUser(initialMessage = '', isError = false) {
            if (!Auth.isMaster()) { navigate('/admin'); return; }
            let companies = [];
            try {
                const response = await fetch('/api/master/companies', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) companies = await response.json();
            } catch (err) {}
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value, password = event.target.password.value, company_id = event.target.company_id.value;
                try {
                    const response = await fetch('/api/master/create_user', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ username, password, company_id }) });
                    const data = await response.json();
                    renderMasterCreateUser(data.message || '処理完了', !response.ok);
                } catch (err) { renderMasterCreateUser('ネットワークエラー', true); }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">受講者 新規登録 (Master用)</h2>
                    ${initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : ''}
                    <form id="masterCreateUserForm">
                        <div class="form-group"><label for="company_id">所属企業:</label><select class="form-control" name="company_id" required><option value="">選択してください</option>${companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                        <div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div>
                        <div class="form-group"><label>初期パスワード:</label><input type="password" class="form-control" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">登録</button>
                    </form>
                    <div class="text-center mt-3"><a href="/users" class="btn btn-secondary">ユーザー一覧に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('masterCreateUserForm').addEventListener('submit', handleSubmit);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/users'); });
        }

        function renderMasterCreateMaster(initialMessage = '', isError = false) {
            if (!Auth.isMaster()) { navigate('/admin'); return; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const username = event.target.username.value, password = event.target.password.value;
                try {
                    const response = await fetch('/api/master/create_master', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ username, password }) });
                    const data = await response.json();
                    renderMasterCreateMaster(data.message || '処理完了', !response.ok);
                } catch (err) { renderMasterCreateMaster('ネットワークエラー', true); }
            };
            const html = `
                <div class="container">
                    <h2 class="text-center mb-4">マスターユーザー 新規登録</h2>
                    ${initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : ''}
                    <form id="masterCreateMasterForm">
                        <div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div>
                        <div class="form-group"><label>初期パスワード:</label><input type="password" class="form-control" name="password" required></div>
                        <button type="submit" class="btn btn-primary btn-block">登録</button>
                    </form>
                    <div class="text-center mt-3"><a href="/users" class="btn btn-secondary">ユーザー一覧に戻る</a></div>
                </div>`;
            render(html);
            document.getElementById('masterCreateMasterForm').addEventListener('submit', handleSubmit);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/users'); });
        }

        function renderResetPasswordModal(userId, username, message = '', isError = false) {
            const modalContainer = document.getElementById('modal-container');
            const handleSubmit = async (event) => {
                event.preventDefault();
                const new_password = event.target.new_password.value;
                if (!new_password) { renderResetPasswordModal(userId, username, '新しいパスワードを入力してください。', true); return; }
                try {
                    const response = await fetch('/api/master/reset_password', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ user_id: parseInt(userId), new_password }) });
                    const data = await response.json();
                    renderResetPasswordModal(userId, username, data.message || '処理完了', !response.ok);
                } catch (err) { renderResetPasswordModal(userId, username, 'ネットワークエラー', true); }
            };
            const closeModal = () => { modalContainer.innerHTML = ''; };
            const html = `
                <div id="resetModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close-button" id="closeModalBtn">&times;</span>
                        <h4>${username} のパスワードをリセット</h4>
                        ${message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : ''}
                        <form id="resetPasswordForm">
                            <div class="form-group">
                                <label>新しいパスワード:</label>
                                <input type="password" class="form-control" name="new_password" required>
                            </div>
                            <button type="submit" class="btn btn-warning btn-block">パスワードを更新</button>
                        </form>
                    </div>
                </div>`;
            modalContainer.innerHTML = html;
            document.getElementById('resetPasswordForm').addEventListener('submit', handleSubmit);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        }

        // --- ルーティングロジック ---
        function handleRouting() {
            const path = window.location.pathname;
            if (!Auth.isAuthenticated() && path !== '/login' && path !== '/signup') { navigate('/login'); return; }
            switch (true) {
                case path === '/login' || path === '/': renderLogin(); break;
                case path === '/signup': renderSignup(); break;
                case path === '/dashboard': renderDashboard(); break;
                case path === '/my_results': renderMyResults(); break;
                case path === '/admin': renderAdmin(); break;
                case path === '/users': renderUserList(); break;
                case path === '/register_company': renderRegisterCompany(); break;
                case path === '/create_user': renderCreateUser(); break;
                case path === '/master/create_user': renderMasterCreateUser(); break;
                case path === '/master/create_master': renderMasterCreateMaster(); break;
                // 注意：以下のクイズ関連のルートはまだ新しいDB構造に対応していません
                case path === '/q_list': render('<div>問題一覧ページ（現在開発中）<br><a href="/admin">戻る</a></div>'); break;
                case path === '/genre': render('<div>ジャンル選択ページ（現在開発中）<br><a href="/dashboard">戻る</a></div>'); break;
                default:
                    render('<div>404 Not Found</div>');
                    break;
            }
        }
        
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);
    </script>
</body>
</html>