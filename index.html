<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .error-message { color: red; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .success-message { color: green; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .tab { text-align: center; margin-top: 50px; }
        .tab button { margin: 10px; }
        table { width: 100%; }
        .dashboard-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .dashboard-button { padding: 2rem; font-size: 1.2rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="modal-container"></div>
    <script>
        // --- Global State ---
        const Auth = {
            token: localStorage.getItem('token') || null, username: localStorage.getItem('username') || null, role: localStorage.getItem('role') || null,
            setToken(t) { this.token = t; if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); },
            setUsername(u) { this.username = u; if (u) localStorage.setItem('username', u); else localStorage.removeItem('username'); },
            setRole(r) { this.role = r; if (r) localStorage.setItem('role', r); else localStorage.removeItem('role'); },
            login(t, u, r) { this.setToken(t); this.setUsername(u); this.setRole(r); navigate(r === 'master' || r === 'admin' ? '/admin' : '/dashboard'); },
            logout() { this.setToken(null); this.setUsername(null); this.setRole(null); navigate('/login'); },
            isAuthenticated() { return this.token !== null; },
            isMaster() { return this.isAuthenticated() && this.role === 'master'; },
            isAdmin() { return this.isAuthenticated() && (this.role === 'admin' || this.role === 'master'); }
        };
        let currentQuiz = { questions: [], index: 0 };

        // --- Utility Functions ---
        function render(c) { document.getElementById('root').innerHTML = c; }
        function navigate(p, s={}) { if (window.location.pathname !== p || JSON.stringify(history.state) !== JSON.stringify(s)) { history.pushState(s, '', p); handleRouting(); } }

        // --- Component Functions ---
        function renderLogin(initialMessage = '', isError = true) {
            let message = initialMessage;
            if (history.state && history.state.signupSuccess) {
                message = '登録に成功しました。ログインしてください。'; isError = false;
                history.replaceState({}, '', '/login');
            }
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `<div class="container"><h2 class="text-center mb-4">ログイン</h2>${messageHtml}<form id="loginForm"><div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required></div><button type="submit" class="btn btn-primary btn-block">ログイン</button></form><div class="text-center mt-3"><p>アカウントをお持ちではありませんか？ <a href="/signup">新規登録</a></p></div></div>`;
            render(html);
            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value;
                try {
                    const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    const data = await res.json();
                    if(res.ok) Auth.login(data.token, data.username, data.role);
                    else renderLogin(data.message || 'ログイン失敗', true);
                } catch (err) { renderLogin('ネットワークエラー', true); }
            });
            document.querySelector('a[href="/signup"]').addEventListener('click', e => { e.preventDefault(); navigate('/signup'); });
        }

        function renderSignup(initialMessage = '', isError = true) {
            const messageHtml = initialMessage ? `<div class="${isError ? 'error-message' : 'success-message'}">${initialMessage}</div>` : '';
            const html = `<div class="container"><h2 class="text-center mb-4">新規登録</h2>${messageHtml}<form id="signupForm"><div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required minlength="6"></div><div class="form-group"><label>パスワード(確認):</label><input type="password" class="form-control" name="confirmPassword" required minlength="6"></div><button type="submit" class="btn btn-primary btn-block">登録</button></form><div class="text-center mt-3"><p>既にアカウントをお持ちですか？ <a href="/login">ログイン</a></p></div></div>`;
            render(html);
            document.getElementById('signupForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value, cp = e.target.confirmPassword.value;
                if(p !== cp) { renderSignup('パスワードが一致しません', true); return; }
                try {
                    const res = await fetch('/api/auth/signup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    if(res.ok) { navigate('/login', { signupSuccess: true }); }
                    else { const data = await res.json(); renderSignup(data.message || '登録に失敗しました', true); }
                } catch (err) { renderSignup('ネットワークエラー', true); }
            });
            document.querySelector('a[href="/login"]').addEventListener('click', e => { e.preventDefault(); navigate('/login'); });
        }

        function renderDashboard() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const html = `<div class="container"><h1 class="text-center">ようこそ、${Auth.username}さん</h1><p class="text-center text-muted">操作を選択してください。</p><div class="dashboard-button-grid"><button id="startQuizBtn" class="btn btn-primary dashboard-button">テストを実施</button><button id="myResultsBtn" class="btn btn-info dashboard-button">自分の成績を見る</button><button id="logoutBtn" class="btn btn-danger dashboard-button">ログアウト</button></div></div>`;
            render(html);
            document.getElementById('startQuizBtn').addEventListener('click', () => navigate('/genre'));
            document.getElementById('myResultsBtn').addEventListener('click', () => navigate('/my_results'));
            document.getElementById('logoutBtn').addEventListener('click', () => Auth.logout());
        }

        async function renderMyResults() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let myResults = []; let error = '';
            try {
                const response = await fetch('/api/user/my_results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || '成績の取得に失敗しました。');
                myResults = data;
            } catch (err) { error = err.message.includes('JSON') ? 'サーバーからの応答が不正です。' : err.message; }
            const html = `<div class="container"><h1 class="text-center mb-4">あなたの成績</h1>${error ? `<div class="alert alert-warning">${error}</div>` : ''}${myResults.length > 0 ? `<ul class="list-group">${myResults.map(r => `<li class="list-group-item d-flex justify-content-between"><span>${r.title}</span><span class="badge ${r.is_correct ? 'badge-success' : 'badge-danger'}">${r.is_correct ? '正解' : '不正解'}</span></li>`).join('')}</ul>` : '<p class="text-center">まだ解答履歴がありません。</p>'}<div class="text-center mt-4"><a href="/dashboard" class="btn btn-secondary">マイページに戻る</a></div></div>`;
            render(html);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/dashboard'); });
        }

        function renderAdmin() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const masterButtonHtml = Auth.isMaster() ? `<button id="registerCompanyBtn" class="btn btn-success">企業・管理者登録</button>` : '';
            const adminButtonHtml = Auth.isAdmin() ? `<button id="createUserBtn" class="btn btn-primary">受講者登録</button>` : '';
            const questionMgmtButtonHtml = Auth.isMaster() ? `<button id="qListButton" class="btn btn-info">問題管理</button>` : '';
            const viewResultsButton = Auth.isAdmin() ? `<button id="viewResultsBtn" class="btn btn-secondary">テスト結果</button>` : '';
            const html = `<div class="container"><h1 class="text-center">${Auth.username} の管理画面</h1><p class="text-center text-muted">役割: ${Auth.role}</p><div class="tab">${masterButtonHtml}${adminButtonHtml}<button id="userListButton" class="btn btn-secondary">ユーザー一覧</button>${questionMgmtButtonHtml}${viewResultsButton}<button id="logoutButton" class="btn btn-danger">ログアウト</button></div></div>`;
            render(html);
            if (Auth.isMaster()) { document.getElementById('registerCompanyBtn').addEventListener('click', () => navigate('/register_company')); }
            if (Auth.isAdmin()) { document.getElementById('createUserBtn').addEventListener('click', () => navigate('/create_user')); }
            if (Auth.isMaster()) { if(document.getElementById('qListButton')) document.getElementById('qListButton').addEventListener('click', () => navigate('/q_list')); }
            if (Auth.isAdmin()) { if(document.getElementById('viewResultsBtn')) document.getElementById('viewResultsBtn').addEventListener('click', () => navigate('/view')); }
            document.getElementById('userListButton').addEventListener('click', () => navigate('/users'));
            document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
        }
        
        async function renderView() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let results = []; let error = '';
            try {
                const response = await fetch('/api/admin/results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || '結果の取得に失敗しました。');
                results = data;
            } catch (err) { error = err.message.includes('JSON') ? 'サーバーからの応答が不正です。' : err.message; }
            const groupedResults = {};
            results.forEach(r => {
                if (!groupedResults[r.username]) groupedResults[r.username] = [];
                groupedResults[r.username].push(r);
            });
            const html = `<div class="container"><h1 class="text-center mb-4">全ユーザーのテスト結果</h1>${error ? `<div class="alert alert-warning">${error}</div>` : ''}${Object.keys(groupedResults).length > 0 ? Object.entries(groupedResults).map(([username, userResults]) => `<h3 class="mt-4">${username} (${userResults[0].company_name || 'N/A'})</h3><ul class="list-group">${userResults.map(r => `<li class="list-group-item d-flex justify-content-between"><span>${r.title}</span><span class="badge ${r.is_correct ? 'badge-success' : 'badge-danger'}">${r.is_correct ? '正解' : '不正解'}</span></li>`).join('')}</ul>`).join('') : '<p class="text-center">まだ解答履歴がありません。</p>'}<div class="text-center mt-4"><a href="/admin" class="btn btn-secondary">管理画面に戻る</a></div></div>`;
            render(html);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/admin'); });
        }

        async function renderUserList() { /* ... This function is complete from the previous full version ... */ }
        function renderRegisterCompany(initialMessage, isError) { /* ... This function is complete from the previous full version ... */ }
        function renderCreateUser(initialMessage, isError) { /* ... This function is complete from the previous full version ... */ }
        async function renderMasterCreateUser(initialMessage, isError) { /* ... This function is complete from the previous full version ... */ }
        function renderMasterCreateMaster(initialMessage, isError) { /* ... This function is complete from the previous full version ... */ }
        function renderResetPasswordModal(userId, username, message, isError) { /* ... This function is complete from the previous full version ... */ }
        async function renderQuestionList() { /* ... This function is complete from the previous full version ... */ }
        function renderCreateQuestion(initialMessage, isError) { /* ... This function is complete from the previous full version ... */ }
        
        async function renderGenre() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            let genres = []; let error = '';
            try {
                const response = await fetch('/api/quiz/genres', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (response.ok) { genres = await response.json(); }
                else { throw new Error('ジャンルの取得に失敗'); }
            } catch (err) { error = err.message; }
            const handleSubmit = async (event) => {
                event.preventDefault();
                const genre = event.target.genre.value;
                const count = event.target.count.value;
                try {
                    const res = await fetch(`/api/quiz/start?genre=${genre}&count=${count}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                    if (!res.ok) throw new Error('問題の取得に失敗しました。');
                    const questions = await res.json();
                    currentQuiz = { questions: questions, index: 0 };
                    navigate('/question');
                } catch (err) { document.getElementById('error-container').innerText = err.message; }
            };
            const html = `<div class="container"><h1 class="text-center mb-4">テスト設定</h1><div id="error-container" class="error-message"></div>${genres.length > 0 ? `<form id="genreForm"><div class="form-group"><label>ジャンル選択:</label><select class="form-control" name="genre">${genres.map(g => `<option value="${g}">${g}</option>`).join('')}</select></div><div class="form-group"><label>問題数:</label><input type="number" class="form-control" name="count" value="10" min="1" max="50"></div><button type="submit" class="btn btn-primary btn-block">テスト開始</button></form>` : `<p class="text-center">${error || '解答可能な問題がありません。'}</p>`}<div class="text-center mt-3"><a href="/dashboard" class="btn btn-secondary">マイページに戻る</a></div></div>`;
            render(html);
            if(genres.length > 0) document.getElementById('genreForm').addEventListener('submit', handleSubmit);
            document.querySelector('.btn-secondary').addEventListener('click', e => { e.preventDefault(); navigate('/dashboard'); });
        }

        function renderQuestion() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            if (currentQuiz.questions.length === 0 || currentQuiz.index >= currentQuiz.questions.length) {
                alert('テストが終了しました。'); navigate('/dashboard'); return;
            }
            const q = currentQuiz.questions[currentQuiz.index];
            const handleSubmit = async (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);
                const userAnswer = formData.getAll('user_answer');
                try {
                    const res = await fetch('/api/quiz/submit_answer', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify({ question_id: q.id, user_answer: userAnswer }) });
                    if (!res.ok) throw new Error('解答の送信に失敗しました。');
                    const resultData = await res.json();
                    navigate('/kekka', { resultData });
                } catch (err) { alert(err.message); }
            };
            const html = `<div class="container"><h2 class="text-center mb-4">問題 ${currentQuiz.index + 1} / ${currentQuiz.questions.length}</h2><div class="card"><div class="card-header">${q.title}</div><div class="card-body"><form id="questionForm">${(q.choices || "").split(':').map(c => `<div class="form-check"><input class="form-check-input" type="checkbox" name="user_answer" value="${c}" id="choice-${c}"><label class="form-check-label" for="choice-${c}">${c}</label></div>`).join('')}<button type="submit" class="btn btn-primary btn-block mt-4">解答する</button></form></div></div></div>`;
            render(html);
            document.getElementById('questionForm').addEventListener('submit', handleSubmit);
        }
        
        function renderKekka(state) {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const { resultData } = state || {};
            if (!resultData) { navigate('/dashboard'); return; }
            const q = currentQuiz.questions[currentQuiz.index];
            const resultHtml = resultData.is_correct ? `<h2 class="text-success">正解！</h2>` : `<h2 class="text-danger">不正解...</h2>`;
            const html = `<div class="container"><div class="text-center mb-3">${resultHtml}</div><p><strong>問題:</strong> ${q.title}</p><p><strong>正解:</strong> ${resultData.correct_answer.join(', ')}</p>${resultData.explanation ? `<p><strong>解説:</strong> ${resultData.explanation}</p>` : ''}<div class="text-center mt-4"><button id="nextQuestionBtn" class="btn btn-primary">次の問題へ</button></div></div>`;
            render(html);
            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                currentQuiz.index++;
                navigate('/question');
            });
        }
        
        // --- Routing Logic ---
        function handleRouting() {
            const path = window.location.pathname;
            if (!Auth.isAuthenticated() && path !== '/login' && path !== '/signup') { navigate('/login'); return; }
            switch (true) {
                case path === '/login' || path === '/': renderLogin(history.state?.message, !history.state?.success); break;
                case path === '/signup': renderSignup(); break;
                case path === '/dashboard': renderDashboard(); break;
                case path === '/my_results': renderMyResults(); break;
                case path === '/admin': renderAdmin(); break;
                case path === '/users': renderUserList(); break;
                case path === '/register_company': renderRegisterCompany(); break;
                case path === '/create_user': renderCreateUser(); break;
                case path === '/master/create_user': renderMasterCreateUser(); break;
                case path === '/master/create_master': renderMasterCreateMaster(); break;
                case path === '/q_list': renderQuestionList(); break;
                case path === '/create_question': renderCreateQuestion(); break;
                case path === '/genre': renderGenre(); break;
                case path === '/question': renderQuestion(); break;
                case path === '/kekka': renderKekka(history.state); break;
                case path === '/view': renderView(); break;
                default:
                    render('<div>404 Not Found</div>');
                    break;
            }
        }
        
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);
    </script>
</body>
</html>