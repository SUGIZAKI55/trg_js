<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .error-message { color: red; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .success-message { color: green; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .dashboard-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .dashboard-button { padding: 2rem; font-size: 1.2rem; }
        /* モーダル用のスタイル */
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
        .choice-label { display: block; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .choice-label:hover { background-color: #f0f0f0; }
        .result-correct { border-left: 5px solid #28a745; }
        .result-incorrect { border-left: 5px solid #dc3545; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="modal-container"></div>
    <script>
        // --- Global State & Auth Management ---
        const Auth = {
            token: localStorage.getItem('token') || null, username: localStorage.getItem('username') || null, role: localStorage.getItem('role') || null,
            setToken(t) { this.token = t; if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); },
            setUsername(u) { this.username = u; if (u) localStorage.setItem('username', u); else localStorage.removeItem('username'); },
            setRole(r) { this.role = r; if (r) localStorage.setItem('role', r); else localStorage.removeItem('role'); },
            login(t, u, r) { this.setToken(t); this.setUsername(u); this.setRole(r); navigate(this.isAdmin() ? '/admin' : '/dashboard'); },
            logout() { this.setToken(null); this.setUsername(null); this.setRole(null); navigate('/login'); },
            isAuthenticated() { return this.token !== null; },
            isMaster() { return this.isAuthenticated() && this.role === 'master'; },
            isAdmin() { return this.isAuthenticated() && (this.role === 'admin' || this.role === 'master'); }
        };
        let currentQuiz = { questions: [], index: 0, session_id: null, results: [] };

        // --- Utility Functions ---
        function render(c) { document.getElementById('root').innerHTML = c; }
        function navigate(path, state = {}) {
            if (window.location.pathname !== path) {
                history.pushState(state, '', path);
            }
            handleRouting(); // 常にルーティングを処理して再描画
        }
        function showModal(content) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal" style="display:block;"><div class="modal-content"><span class="close-button">&times;</span>${content}</div></div>`;
            modalContainer.querySelector('.close-button').onclick = () => { modalContainer.innerHTML = ''; };
            modalContainer.querySelector('.modal').onclick = (e) => { if(e.target === e.currentTarget) modalContainer.innerHTML = ''; };
        }
        function hideModal() { document.getElementById('modal-container').innerHTML = ''; }

        // --- Core Components ---
        function renderLogin(message = '', isError = true) {
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `<div class="container"><h2 class="text-center mb-4">ログイン</h2>${messageHtml}<form id="loginForm"><div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required></div><button type="submit" class="btn btn-primary btn-block">ログイン</button></form><div class="text-center mt-3"><p>アカウントをお持ちではありませんか？ <a href="/signup" onclick="event.preventDefault(); navigate('/signup');">新規登録</a></p></div></div>`;
            render(html);
            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value;
                try {
                    const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    const data = await res.json();
                    if(res.ok) Auth.login(data.token, data.username, data.role);
                    else renderLogin(data.message || 'ログイン失敗', true);
                } catch (err) { renderLogin('ネットワークエラー', true); }
            });
        }

        function renderSignup(message = '', isError = true) {
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `<div class="container"><h2 class="text-center mb-4">新規登録</h2>${messageHtml}<form id="signupForm"><div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required minlength="6"></div><div class="form-group"><label>パスワード(確認):</label><input type="password" class="form-control" name="confirmPassword" required></div><button type="submit" class="btn btn-primary btn-block">登録</button></form><div class="text-center mt-3"><p>既にアカウントをお持ちですか？ <a href="/login" onclick="event.preventDefault(); navigate('/login');">ログイン</a></p></div></div>`;
            render(html);
            document.getElementById('signupForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value, cp = e.target.confirmPassword.value;
                if(p !== cp) { renderSignup('パスワードが一致しません', true); return; }
                try {
                    const res = await fetch('/api/auth/signup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    if(res.ok) { navigate('/login', { message: '登録に成功しました。ログインしてください。', success: true }); }
                    else { const data = await res.json(); renderSignup(data.message || '登録失敗', true); }
                } catch (err) { renderSignup('ネットワークエラー', true); }
            });
        }
        
        function renderDashboard() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const roleDisplay = Auth.isAdmin() ? `<p class="text-center text-danger">役割: ${Auth.role.toUpperCase()}</p>` : `<p class="text-center text-success">役割: ${Auth.role.toUpperCase()}</p>`;
            const adminButton = Auth.isAdmin() ? `<button onclick="navigate('/admin')" class="btn btn-secondary dashboard-button">管理画面へ</button>` : '';
            const html = `<div class="container"><h1 class="text-center">ようこそ、${Auth.username}さん</h1>${roleDisplay}<div class="dashboard-button-grid">${adminButton}<button onclick="navigate('/genre')" class="btn btn-primary dashboard-button">簿記クイズを開始</button><button onclick="navigate('/my_results')" class="btn btn-info dashboard-button">自分の成績を見る</button><button onclick="Auth.logout()" class="btn btn-danger dashboard-button">ログアウト</button></div></div>`;
            render(html);
        }

        // --- クイズ機能 ---
        async function renderGenre() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            try {
                const res = await fetch('/api/quiz/genres', { headers: {'Authorization': `Bearer ${Auth.token}`} });
                if (!res.ok) throw new Error('ジャンルの読み込みに失敗しました。');
                const genres = await res.json();
                const html = `<div class="container"><h2 class="text-center">クイズ設定</h2><form id="quizStartForm"><div class="form-group"><label for="genre">ジャンルを選択してください:</label><select id="genre" name="genre" class="form-control">${genres.map(g => `<option value="${g}">${g}</option>`).join('')}</select></div><div class="form-group"><label for="count">問題数:</label><input type="number" id="count" name="count" class="form-control" value="10" min="1" max="50"></div><button type="submit" class="btn btn-primary btn-block">クイズ開始</button></form><div class="text-center mt-3"><a href="/dashboard" onclick="event.preventDefault(); navigate('/dashboard');" class="btn btn-secondary">戻る</a></div></div>`;
                render(html);
                document.getElementById('quizStartForm').addEventListener('submit', async e => {
                    e.preventDefault();
                    const genre = e.target.genre.value, count = e.target.count.value;
                    const startRes = await fetch(`/api/quiz/start?genre=${genre}&count=${count}`, { headers: {'Authorization': `Bearer ${Auth.token}`} });
                    if (!startRes.ok) { const err = await startRes.json(); alert(err.message); return; }
                    const questions = await startRes.json();
                    currentQuiz = { questions, index: 0, session_id: `${Date.now()}-${Auth.username}`, results: [] };
                    navigate('/question');
                });
            } catch (err) { render(`<div class="container error-message">${err.message}</div>`); }
        }

        function renderQuestion() {
            if (!Auth.isAuthenticated() || currentQuiz.questions.length === 0) { navigate('/dashboard'); return; }
            const q = currentQuiz.questions[currentQuiz.index];
            const choices = q.choices.split(':').map(c => c.trim());
            const html = `<div class="container"><div class="card"><div class="card-header"><h3>問題 ${currentQuiz.index + 1} / ${currentQuiz.questions.length}</h3></div><div class="card-body"><h5 class="card-title">${q.title}</h5><form id="answerForm">${choices.map((choice, i) => `<label class="choice-label"><input type="checkbox" name="answer" value="${choice}"> ${choice}</label>`).join('')}</form></div><div class="card-footer"><button id="submitAnswerBtn" class="btn btn-primary">解答する</button></div></div></div>`;
            render(html);
            document.getElementById('submitAnswerBtn').addEventListener('click', async () => {
                const selectedAnswers = Array.from(document.querySelectorAll('input[name="answer"]:checked')).map(el => el.value);
                if (selectedAnswers.length === 0) { alert('解答を選択してください。'); return; }
                const res = await fetch('/api/quiz/submit_answer', {
                    method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}`},
                    body: JSON.stringify({ question_id: q.id, user_answer: selectedAnswers, session_id: currentQuiz.session_id })
                });
                const result = await res.json();
                currentQuiz.results.push(result.is_correct);
                showAnswerResult(result);
            });
        }
        
        function showAnswerResult(result) {
            const resultClass = result.is_correct ? 'success' : 'danger';
            const resultText = result.is_correct ? '正解！' : '不正解...';
            const modalContent = `<div class="alert alert-${resultClass}"><h3>${resultText}</h3></div><p><strong>正解:</strong> ${result.correct_answer.join(', ')}</p>${result.explanation ? `<p><strong>解説:</strong> ${result.explanation}</p>` : ''}<button id="nextQuestionBtn" class="btn btn-primary float-right">次へ</button>`;
            showModal(modalContent);
            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                hideModal();
                currentQuiz.index++;
                if (currentQuiz.index < currentQuiz.questions.length) {
                    renderQuestion();
                } else {
                    navigate('/kekka');
                }
            });
        }

        function renderKekka() {
            if (!Auth.isAuthenticated()) { navigate('/login'); return; }
            const correctCount = currentQuiz.results.filter(Boolean).length;
            const total = currentQuiz.questions.length;
            const score = total > 0 ? (correctCount / total * 100).toFixed(1) : 0;
            const html = `<div class="container text-center"><div class="card"><div class="card-body"><h1>クイズ結果</h1><h2>${correctCount} / ${total} 問正解！</h2><h3>スコア: ${score}点</h3><canvas id="resultChart" width="400" height="200"></canvas><div class="mt-4"><button onclick="navigate('/dashboard')" class="btn btn-primary">ダッシュボードに戻る</button> <button onclick="navigate('/genre')" class="btn btn-secondary">もう一度挑戦</button></div></div></div></div>`;
            render(html);
            const ctx = document.getElementById('resultChart').getContext('2d');
            new Chart(ctx, { type: 'doughnut', data: { labels: ['正解', '不正解'], datasets: [{ data: [correctCount, total - correctCount], backgroundColor: ['#28a745', '#dc3545'] }] } });
        }

        // --- Admin Components ---
        function renderAdmin() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const masterHtml = Auth.isMaster() ? `<button onclick="navigate('/register_company')" class="btn btn-success dashboard-button">企業・管理者登録</button><button onclick="navigate('/create_question')" class="btn btn-info dashboard-button">問題作成</button>`: '';
            const html = `<div class="container"><h1 class="text-center">${Auth.username} の管理画面</h1><p class="text-center text-muted">役割: ${Auth.role}</p><div class="dashboard-button-grid"><button onclick="navigate('/dashboard')" class="btn btn-secondary dashboard-button">一般画面に戻る</button><button onclick="navigate('/register_staff')" class="btn btn-primary dashboard-button">スタッフ登録</button><button onclick="navigate('/users')" class="btn btn-warning dashboard-button">ユーザー一覧</button><button onclick="navigate('/q_list')" class="btn btn-info dashboard-button">問題管理</button><button onclick="navigate('/view')" class="btn btn-dark dashboard-button">全テスト結果</button>${masterHtml}<button onclick="Auth.logout()" class="btn btn-danger dashboard-button">ログアウト</button></div></div>`;
            render(html);
        }

        async function renderMyResults() {
             if (!Auth.isAuthenticated()) { navigate('/login'); return; }
             let error = '';
             let runsHtml = '<p class="text-center">まだ解答履歴がありません。</p>';
             try {
                 const res = await fetch('/api/user/my_results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                 if (!res.ok) throw new Error((await res.json()).message || '成績の取得に失敗');
                 const myResults = await res.json();
                 
                 const quizRuns = {};
                 myResults.forEach(r => {
                     if (!quizRuns[r.session_id]) quizRuns[r.session_id] = { total: 0, correct: 0, timestamp: r.timestamp };
                     quizRuns[r.session_id].total++;
                     if (r.is_correct) quizRuns[r.session_id].correct++;
                 });
                 if (Object.keys(quizRuns).length > 0) {
                     runsHtml = `<ul class="list-group">${Object.values(quizRuns).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(run => `<li class="list-group-item d-flex justify-content-between"><span>実施日時: ${new Date(run.timestamp).toLocaleString()}</span><span><strong>${run.correct} / ${run.total} 問正解</strong> (${((run.correct / run.total) * 100).toFixed(0)}%)</span></li>`).join('')}</ul>`;
                 }
             } catch (err) { error = err.message; }
             const html = `<div class="container"><h1 class="text-center mb-4">あなたの成績履歴</h1>${error ? `<div class="alert alert-danger">${error}</div>` : runsHtml}<div class="text-center mt-4"><button onclick="navigate('/dashboard')" class="btn btn-secondary">戻る</button></div></div>`;
             render(html);
        }

        async function renderView() { // 全ユーザーの結果表示
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
             let error = '';
             let groupedHtml = '<p class="text-center">まだ解答履歴がありません。</p>';
             try {
                 const res = await fetch('/api/admin/results', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                 if (!res.ok) throw new Error((await res.json()).message || '結果の取得に失敗');
                 const results = await res.json();
                 
                 const groupedRuns = {};
                 results.forEach(r => {
                     const key = `${r.username}-${r.session_id}`;
                     if (!groupedRuns[key]) groupedRuns[key] = { username: r.username, company_name: r.company_name || 'N/A', total: 0, correct: 0, timestamp: r.timestamp };
                     groupedRuns[key].total++;
                     if (r.is_correct) groupedRuns[key].correct++;
                 });
                 
                 if (Object.keys(groupedRuns).length > 0) {
                    groupedHtml = Object.values(groupedRuns).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(run => `<div class="card mt-3"><div class="card-header">${run.username} (${run.company_name})</div><div class="card-body">実施日時: ${new Date(run.timestamp).toLocaleString()}<br><strong>スコア: ${run.correct} / ${run.total} 問正解</strong> (${((run.correct / run.total) * 100).toFixed(0)}%)</div></div>`).join('');
                 }
             } catch (err) { error = err.message; }
             const html = `<div class="container"><h1 class="text-center mb-4">全ユーザーのテスト結果</h1>${error ? `<div class="alert alert-danger">${error}</div>` : groupedHtml}<div class="text-center mt-4"><button onclick="navigate('/admin')" class="btn btn-secondary">管理画面に戻る</button></div></div>`;
             render(html);
        }

        async function renderUserList() { 
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let error = '', users = [];
            try {
                const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!res.ok) throw new Error((await res.json()).message);
                users = await res.json();
            } catch (err) { error = err.message; }
            const html = `<div class="container"><h1 class="text-center mb-4">ユーザー一覧</h1>${error ? `<div class="error-message">${error}</div>` : ''}<table class="table table-striped"><thead><tr><th>ID</th><th>ユーザー名</th><th>役割</th><th>会社名</th></tr></thead><tbody>${users.map(u => `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td><td>${u.company_name || 'N/A'}</td></tr>`).join('')}</tbody></table><div class="text-center mt-4"><button onclick="navigate('/admin')" class="btn btn-secondary">管理画面に戻る</button></div></div>`;
            render(html);
        }

        // --- Routing ---
        function handleRouting() {
            const path = window.location.pathname;
            const state = history.state || {};
            if (!Auth.isAuthenticated() && !['/login', '/signup', '/'].includes(path)) { navigate('/login'); return; }

            const routes = {
                '/': () => renderLogin(state.message, !state.success),
                '/login': () => renderLogin(state.message, !state.success),
                '/signup': () => renderSignup(),
                '/dashboard': () => renderDashboard(),
                '/my_results': () => renderMyResults(),
                '/admin': () => renderAdmin(),
                '/users': () => renderUserList(),
                '/q_list': () => renderQuestionList(), // (次のファイルで実装)
                '/create_question': () => renderCreateQuestion(), // (次のファイルで実装)
                '/register_staff': () => renderRegisterStaff(), // (次のファイルで実装)
                '/register_company': () => renderRegisterCompany(), // (次のファイルで実装)
                '/genre': () => renderGenre(),
                '/question': () => renderQuestion(),
                '/kekka': () => renderKekka(),
                '/view': () => renderView(),
            };
            const action = routes[path] || (() => render('<div>404 Not Found</div>'));
            action();
        }

        // --- App Initialization ---
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('DOMContentLoaded', handleRouting);

        // --- 実装が長くなるため、一部の管理コンポーネントはここに追加 ---
        function renderRegisterStaff(message = '', isError = true) {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `<div class="container"><h2 class="text-center mb-4">スタッフ新規登録</h2>${messageHtml}<form id="registerStaffForm"><div class="form-group"><label>ユーザー名:</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>パスワード:</label><input type="password" class="form-control" name="password" required minlength="6"></div><div class="form-group"><label>権限:</label><select class="form-control" name="role"><option value="staff">スタッフ</option><option value="admin">管理者</option>${Auth.isMaster() ? '<option value="master">マスター</option>' : ''}</select></div><button type="submit" class="btn btn-primary btn-block">登録</button></form><div class="text-center mt-3"><button onclick="navigate('/admin')" class="btn btn-secondary">管理画面に戻る</button></div></div>`;
            render(html);
            document.getElementById('registerStaffForm').addEventListener('submit', async e => {
                e.preventDefault();
                const u = e.target.username.value, p = e.target.password.value, r = e.target.role.value;
                try {
                    const res = await fetch('/api/admin/create_user', { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}`}, body: JSON.stringify({username: u, password: p, role: r}) });
                    const data = await res.json();
                    if(res.ok) renderRegisterStaff(data.message, false); else renderRegisterStaff(data.message, true);
                } catch (err) { renderRegisterStaff('ネットワークエラー', true); }
            });
        }
        async function renderQuestionList() {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            let error = '', questions = [];
            try {
                const res = await fetch('/api/questions', { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if (!res.ok) throw new Error((await res.json()).message);
                questions = await res.json();
            } catch (err) { error = err.message; }

            const handleDelete = async (id) => {
                if (!confirm('本当にこの問題を削除しますか？')) return;
                const res = await fetch(`/api/questions/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if(res.ok) navigate('/q_list'); else alert('削除失敗');
            };
            const html = `<div class="container"><h1 class="text-center mb-4">問題管理</h1>${error ? `<div class="error-message">${error}</div>` : ''}<button onclick="navigate('/create_question')" class="btn btn-primary mb-3">新規問題作成</button><div class="table-responsive"><table class="table table-bordered"><thead><tr><th>ID</th><th>ジャンル</th><th>問題文</th><th>操作</th></tr></thead><tbody>${questions.length > 0 ? questions.map(q => `<tr><td>${q.id}</td><td>${q.genre}</td><td>${q.title.substring(0, 50)}...</td><td><button class="btn btn-sm btn-info" onclick='navigate("/create_question", {questionId: ${q.id}})'>編集</button> <button class="btn btn-sm btn-danger" onclick='handleDelete(${q.id})'>削除</button></td></tr>`).join('') : '<tr><td colspan="4" class="text-center">問題がありません。</td></tr>'}</tbody></table></div><div class="text-center mt-4"><button onclick="navigate('/admin')" class="btn btn-secondary">管理画面に戻る</button></div></div>`;
            render(html);
            window.handleDelete = handleDelete; // グローバルスコープに関数をアタッチ
        }
        async function renderCreateQuestion(message = '', isError = true) {
            if (!Auth.isAdmin()) { navigate('/dashboard'); return; }
            const questionId = history.state?.questionId;
            const isEditing = !!questionId;
            let q = { genre: '', title: '', choices: '', answer: '', explanation: '' };

            if(isEditing) {
                const res = await fetch(`/api/questions/${questionId}`, { headers: { 'Authorization': `Bearer ${Auth.token}` } });
                if(res.ok) q = await res.json();
            }
            
            const messageHtml = message ? `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>` : '';
            const html = `<div class="container"><h1 class="text-center mb-4">${isEditing ? '問題編集' : '問題作成'}</h1>${messageHtml}<form id="questionForm"><div class="form-group"><label>ジャンル:</label><input type="text" class="form-control" name="genre" value="${q.genre}" required></div><div class="form-group"><label>問題文:</label><textarea class="form-control" name="title" rows="3" required>${q.title}</textarea></div><div class="form-group"><label>選択肢 (コロン:区切り):</label><input type="text" class="form-control" name="choices" value="${q.choices}" required></div><div class="form-group"><label>正解 (コロン:区切り):</label><input type="text" class="form-control" name="answer" value="${q.answer}" required></div><div class="form-group"><label>解説:</label><textarea class="form-control" name="explanation" rows="2">${q.explanation}</textarea></div><button type="submit" class="btn btn-primary btn-block">${isEditing ? '更新' : '作成'}</button></form><div class="text-center mt-4"><button onclick="navigate('/q_list')" class="btn btn-secondary">一覧に戻る</button></div></div>`;
            render(html);

            document.getElementById('questionForm').addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `/api/questions/${questionId}` : '/api/questions';
                try {
                    const res = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${Auth.token}` }, body: JSON.stringify(data) });
                    if (!res.ok) throw new Error((await res.json()).message);
                    navigate('/q_list');
                } catch (err) { renderCreateQuestion(err.message, true); }
            });
        }
        function renderRegisterCompany() { /* 実装は省略 */ render('<div class="container"><h1>企業登録</h1><p>UIは省略</p><button onclick="navigate(\'/admin\')">戻る</button></div>'); }
    </script>
</body>
</html>